<!DOCTYPE html>
<html lang="en">

<head>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66582-32"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-66582-32');
    </script>

    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Feature Ingestion from Redshift" />
<meta property="og:description" content="Redshift Integration This notebooks guides through the ingestion of Redshift data in the Hopsworks feature store. To follow this notebook users should have an existing Redshift cluster, if not, they can follow the AWS documentation.
The data for this tutorial is available in CSV format [here]() Users should create the following table in Redshift
CREATE TABLE telco( customer_id varchar(200), gender varchar(200), senior_citizen integer, partner varchar(200), dependents varchar(200), tenure integer, phone_service varchar(200), multiple_lines varchar(200), internet_service varchar(200), online_security varchar(200), online_backup varchar(200), device_protection varchar(200), tech_support varchar(200), streaming_tv varchar(200), streaming_movies varchar(200), contract varchar(200), paperless_billing varchar(200), payment_method varchar(200), monthly_charges double precision, total_charges varchar(200), churn varchar(200) ) and populate the table using the copy command:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://examples.hopsworks.ai/featurestore/aws/redshift/redshift_spark/" />



<meta property="article:published_time" content="2021-02-24T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2021-02-24T00:00:00&#43;00:00"/>











<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Feature Ingestion from Redshift"/>
<meta name="twitter:description" content="Redshift Integration This notebooks guides through the ingestion of Redshift data in the Hopsworks feature store. To follow this notebook users should have an existing Redshift cluster, if not, they can follow the AWS documentation.
The data for this tutorial is available in CSV format [here]() Users should create the following table in Redshift
CREATE TABLE telco( customer_id varchar(200), gender varchar(200), senior_citizen integer, partner varchar(200), dependents varchar(200), tenure integer, phone_service varchar(200), multiple_lines varchar(200), internet_service varchar(200), online_security varchar(200), online_backup varchar(200), device_protection varchar(200), tech_support varchar(200), streaming_tv varchar(200), streaming_movies varchar(200), contract varchar(200), paperless_billing varchar(200), payment_method varchar(200), monthly_charges double precision, total_charges varchar(200), churn varchar(200) ) and populate the table using the copy command:"/>
<meta name="generator" content="Hugo 0.40.3" />

    
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Feature Ingestion from Redshift",
  "url": "https://examples.hopsworks.ai/featurestore/aws/redshift/redshift_spark/",
  "wordCount": "1418",
  "datePublished": "2021-02-24T00:00:00&#43;00:00",
  "dateModified": "2021-02-24T00:00:00&#43;00:00",
  "author": {
  "@type": "Person",
  "name": ""
  }
  }
</script> 

    <title>Feature Ingestion from Redshift</title>

    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">

    
    <link href="https://examples.hopsworks.ai/css/custom.css" rel="stylesheet">
    <link href="https://examples.hopsworks.ai/css/syntax.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli:400,500,700" rel="stylesheet">

    <link href="" rel="alternate" type="application/rss+xml" title="Hopsworks Examples" />

    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</head>

<body>

    <nav class="navbar navbar-expand-sm fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="https://examples.hopsworks.ai">Hopsworks Examples</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="nav navbar-nav mr-auto"></ul>
                <ul class="nav navbar-nav">
                    <li><a href="https://hopsworks.ai" title="Hopsworks.ai">hopsworks.ai</a></li>
                    <li><a href="https://docs.hopsworks.ai" title="Docs">docs.hopsworks.ai</a></li>
                </ul>
            </div>
        </div>
    </nav>


    
    <div class="container">
        <div class="row">
            <div class="col-sm-12">

                 


<article>
  <div class="technical_note">
    <header>
      <div class="alert alert-warning flashcard_ad" role="alert">
	Want to learn machine learning? Try my <a href="https://machinelearningflashcards.com" class="alert-link">machine learning flashcards</a>, <a href='https://amzn.to/2HwnWty' class="alert-link">book</a>, or <a href='https://www.youtube.com/channel/UCnd4Fi-ODvuPbxR2fO2j7kA' class="alert-link">study with me.</a>.
      </div>
      <h1 class="technical_note_title">Feature Ingestion from Redshift</h1>
      <div class="technical_note_date">
	<time datetime=" 2021-02-24T00:00:00Z "> 24 Feb 2021</time>
      </div>
    </header>
    <div class="content">

      <h2 style="color: #1EB382;font-weight: bold;">Redshift Integration</h2>

<p>This notebooks guides through the ingestion of Redshift data in the Hopsworks feature store. To follow this notebook users should have an existing Redshift cluster, if not, they can follow the AWS <a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/event-publishing-redshift-cluster.html">documentation</a>.</p>

<p>The data for this tutorial is available in CSV format [here]()
Users should create the following table in Redshift</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">telco</span><span class="p">(</span>
    <span class="n">customer_id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">gender</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">senior_citizen</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">partner</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">dependents</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">tenure</span> <span class="nb">integer</span><span class="p">,</span>
    <span class="n">phone_service</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">multiple_lines</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">internet_service</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">online_security</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">online_backup</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">device_protection</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">tech_support</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">streaming_tv</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">streaming_movies</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">contract</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">paperless_billing</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">payment_method</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">monthly_charges</span> <span class="n">double</span> <span class="k">precision</span><span class="p">,</span>
    <span class="n">total_charges</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
    <span class="n">churn</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="p">)</span></code></pre></div>
<p>and populate the table using the copy command:</p>
<div class="highlight"><pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">COPY</span> <span class="n">telco</span>
<span class="k">FROM</span> <span class="s1">&#39;s3://bucket/telco_customer_churn.csv&#39;</span>
<span class="n">IAM_ROLE</span> <span class="s1">&#39;arn:aws:iam::xxxxxxxxx:role/role_name&#39;</span>
<span class="n">FORMAT</span> <span class="k">as</span> <span class="n">CSV</span>
<span class="n">FILLRECORD</span></code></pre></div>
<p>Once the data has been imported into Redshift, we can start ingesting it into the Hopsworks Feature Store.</p>

<h3 style="color: #1EB382;font-weight: bold;">Storage Connector</h3>

<p>The first step to be able to ingest Redshift data into the feature store is to configure a storage connector.The Redshift connector requires you to specify the following properties. Most of them are available in the properties area of your cluster in the Redshift UI.</p>

<p><img src="images/connector_ui.png" alt="Redshift Connector UI" style="margin: auto; height: 600px; width:550px;"/></p>

<ul>
<li><p>Cluster identifier: The name of the cluster</p></li>

<li><p>Database driver: You can use the default JDBC Redshift Driver <code>com.amazon.redshift.jdbc42.Driver</code> (More on this later)</p></li>

<li><p>Database endpoint: The endpoint for the database. Should be in the format of <code>[UUID].eu-west-1.redshift.amazonaws.com</code></p></li>

<li><p>Database name: The name of the database to query</p></li>

<li><p>Database port: The port of the cluster. Defaults to 5349</p></li>
</ul>

<p>There are two options available for authenticating with the Redshift cluster. The first option is to configure a username and a password. The password is stored in the secret store and made available to all the members of the project.
The second option is to configure an IAM role. With IAM roles,  Jobs or notebooks launched on Hopsworks  do not need to explicitly authenticate with Redshift, as the HSFS library will transparently use the IAM role to acquire a temporary credential to authenticate the specified user.
In Hopsworks, there are two different ways to configure an IAM role: a per-cluster IAM role or a federated IAM role (role chaining). For the per-cluster IAM role, you select an instance profile for your Hopsworks cluster when launching it in hopsworks.ai, and all jobs or notebooks will be run with the selected IAM role.  For the federated IAM role, you create a head IAM role for the cluster that enables Hopsworks to assume a potentially different IAM role in each project. You can even restrict it so that only certain roles within a project (like a data owner) can assume a given role.</p>

<p>With regards to the database driver, the library to interact with Redshift <em>is not</em> included in Hopsworks - you need to upload the driver yourself. First, you need to download the library from  here. You then upload the driver files to the “Resources” dataset in your project. Then, you add the file to your notebook or job before launching it, as shown in the screenshots below.</p>

<p>The library can be downloaded here: <a href="https://docs.aws.amazon.com/redshift/latest/mgmt/configure-jdbc-connection.html#download-jdbc-driver">https://docs.aws.amazon.com/redshift/latest/mgmt/configure-jdbc-connection.html#download-jdbc-driver</a></p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">com.logicalclocks.hsfs._</span>
<span class="k">import</span> <span class="nn">scala.collection.JavaConversions._</span>
<span class="k">import</span> <span class="nn">collection.JavaConverters._</span>

<span class="k">import</span> <span class="nn">org.apache.spark.sql.</span><span class="o">{</span> <span class="nc">DataFrame</span><span class="o">,</span> <span class="nc">Row</span> <span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.types._</span>

<span class="k">val</span> <span class="n">connection</span> <span class="k">=</span> <span class="nc">HopsworksConnection</span><span class="o">.</span><span class="n">builder</span><span class="o">().</span><span class="n">build</span><span class="o">();</span>
<span class="k">val</span> <span class="n">fs</span> <span class="k">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">getFeatureStore</span><span class="o">();</span></code></pre></div>
<pre><code>Starting Spark application
</code></pre>

<table>
<tr><th>ID</th><th>YARN Application ID</th><th>Kind</th><th>State</th><th>Spark UI</th><th>Driver log</th></tr><tr><td>36</td><td>application_1608750159023_0006</td><td>spark</td><td>idle</td><td><a target="_blank" href="http://ip-172-31-35-74.eu-west-1.compute.internal:8088/proxy/application_1608750159023_0006/">Link</a></td><td><a target="_blank" href="http://ip-172-31-35-74.eu-west-1.compute.internal:8042/node/containerlogs/container_e02_1608750159023_0006_01_000001/demo_fs_meb10000__meb10000">Link</a></td></tr></table>

<pre><code>SparkSession available as 'spark'.
import com.logicalclocks.hsfs._
import scala.collection.JavaConversions._
import collection.JavaConverters._
import org.apache.spark.sql.{DataFrame, Row}
import org.apache.spark.sql.types._
connection: com.logicalclocks.hsfs.HopsworksConnection = com.logicalclocks.hsfs.HopsworksConnection@5b16ea87
fs: com.logicalclocks.hsfs.FeatureStore = FeatureStore{id=67, name='demo_fs_meb10000_featurestore', projectId=119, featureGroupApi=com.logicalclocks.hsfs.metadata.FeatureGroupApi@3b06db70}
</code></pre>

<h3 style="color: #1EB382;font-weight: bold;">External (On-Demand) Feature Group</h3>

<p>Hopsworks supports the creation of (a) cached feature groups and (b) external (on-demand) feature groups. For cached feature groups, the features are stored in Hopsworks feature store. For external feature groups, only metadata for features is stored in the feature store - not the actual feature data which is read from the external database/object-store. When the external feature group is accessed from a Spark or Python job, the feature data is read on-demand using a connector from the external store. On AWS, Hopsworks supports the creation of external feature groups from a large number of data stores, including Redshift, RDS, Snowflake, S3, and any JDBC-enabled source.</p>

<p>In this example, we will define an external feature group for a table in Redshift. External feature groups in Hopsworks support “provenance” in the Hopsworks Web UI, you can track which features are stored on which external systems and how they are computed. Additionally HSFS (the Python/Scala library used to interact with the feature store) provides the same APIs for external feature groups as for cached feature groups.</p>

<p>An external (on-demand) feature group can be defined as follow:</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="c1">// Retrieve the storage connector defined before
</span><span class="c1"></span><span class="k">val</span> <span class="n">redshiftConn</span> <span class="k">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">getStorageConnector</span><span class="o">(</span><span class="s">&#34;telco_redshift_cluster&#34;</span><span class="o">)</span></code></pre></div>
<pre><code>redshiftConn: com.logicalclocks.hsfs.StorageConnector = StorageConnector(id=1025, name=telco_redshift_cluster, accessKey=null, secretKey=null, serverEncryptionAlgorithm=null, serverEncryptionKey=null, bucket=null, clusterIdentifier=telco-redshift-cluster, databaseDriver=com.amazon.redshift.jdbc42.Driver, databaseEndpoint=cxwh6weoo4ae.eu-west-1.redshift.amazonaws.com, databaseName=dev, databasePort=5439, tableName=null, databaseUserName=awsuser, autoCreate=null, databaseGroup=null, expiration=null, databasePassword=Fabio123, sessionToken=null, connectionString=null, arguments=, storageConnectorType=REDSHIFT)
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">telcoOnDmd</span> <span class="k">=</span> <span class="o">(</span><span class="n">fs</span><span class="o">.</span><span class="n">createOnDemandFeatureGroup</span><span class="o">()</span>
                    <span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;telco_redshift_scala&#34;</span><span class="o">)</span>
                    <span class="o">.</span><span class="n">version</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
                    <span class="o">.</span><span class="n">query</span><span class="o">(</span><span class="s">&#34;select * from telco&#34;</span><span class="o">)</span>
                    <span class="o">.</span><span class="n">description</span><span class="o">(</span><span class="s">&#34;On-demand feature group for telecom customer data&#34;</span><span class="o">)</span>
                    <span class="o">.</span><span class="n">storageConnector</span><span class="o">(</span><span class="n">redshiftConn</span><span class="o">)</span>
                    <span class="o">.</span><span class="n">statisticsEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                    <span class="o">.</span><span class="n">build</span><span class="o">())</span></code></pre></div>
<pre><code>telcoOnDmd: com.logicalclocks.hsfs.OnDemandFeatureGroup = com.logicalclocks.hsfs.OnDemandFeatureGroup@4d876d28
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="n">telcoOnDmd</span><span class="o">.</span><span class="n">save</span><span class="o">()</span></code></pre></div>
<h3 style="color: #1EB382;font-weight: bold;">Engineer features and save to the Feature Store</h3>

<p>On-demand feature groups can be used directly as a source for creating training datasets. This is often the case if a company is migrating to Hopsworks and there are already feature engineering pipelines in production writing data to Redshift.</p>

<p>This flexibility provided by Hopsworks allows users to hit the ground running from day 1, without having to rewrite their pipelines to take advantage of the benefits the Hopsworks feature store provides.</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="n">telcoOnDmd</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;customer_id&#34;</span><span class="o">,</span> <span class="s">&#34;internet_service&#34;</span><span class="o">,</span> <span class="s">&#34;phone_service&#34;</span><span class="o">,</span> <span class="s">&#34;total_charges&#34;</span><span class="o">,</span> <span class="s">&#34;churn&#34;</span><span class="o">)).</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span></code></pre></div>
<pre><code>+-----------+----------------+-------------+-------------+-----+
|customer_id|internet_service|phone_service|total_charges|churn|
+-----------+----------------+-------------+-------------+-----+
| 7590-VHVEG|             DSL|           No|        29.85|   No|
| 5575-GNVDE|             DSL|          Yes|       1889.5|   No|
| 3668-QPYBK|             DSL|          Yes|       108.15|  Yes|
| 7795-CFOCW|             DSL|           No|      1840.75|   No|
| 9237-HQITU|     Fiber optic|          Yes|       151.65|  Yes|
+-----------+----------------+-------------+-------------+-----+
only showing top 5 rows
</code></pre>

<p>On-demand feature groups can also be joined with cached feature groups in Hopsworks to create training datasets. <a href="https://docs.hopsworks.ai/generated/query_vs_dataframe/">This helper guide</a> explains in detail how the HSFS joining APIs work and how they can be used to create training datasets.</p>

<p>If, however, Redshift contains raw data that needs to be feature engineered, you can retrieve a Spark DataFrame backed by the Redshift table using the HSFS API.</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">var</span> <span class="n">sparkDf</span> <span class="k">=</span> <span class="n">telcoOnDmd</span><span class="o">.</span><span class="n">read</span><span class="o">()</span></code></pre></div>
<pre><code>sparkDf: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [customer_id: string, gender: string ... 19 more fields]
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.spark.ml.feature.StringIndexer</span>
<span class="k">import</span> <span class="nn">org.apache.spark.ml.</span><span class="o">{</span><span class="nc">Pipeline</span><span class="o">,</span> <span class="nc">PipelineModel</span><span class="o">}</span></code></pre></div>
<pre><code>import org.apache.spark.ml.feature.StringIndexer
import org.apache.spark.ml.{Pipeline, PipelineModel}
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">categoricalColumns</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;gender&#34;</span><span class="o">,</span> <span class="s">&#34;senior_citizen&#34;</span><span class="o">,</span><span class="s">&#34;partner&#34;</span><span class="o">,</span><span class="s">&#34;dependents&#34;</span><span class="o">,</span><span class="s">&#34;phone_service&#34;</span><span class="o">,</span><span class="s">&#34;multiple_lines&#34;</span><span class="o">,</span>
                      <span class="s">&#34;internet_service&#34;</span><span class="o">,</span> <span class="s">&#34;online_security&#34;</span><span class="o">,</span> <span class="s">&#34;online_backup&#34;</span><span class="o">,</span> <span class="s">&#34;device_protection&#34;</span><span class="o">,</span> <span class="s">&#34;tech_support&#34;</span><span class="o">,</span>
                      <span class="s">&#34;streaming_tv&#34;</span><span class="o">,</span> <span class="s">&#34;streaming_movies&#34;</span><span class="o">,</span> <span class="s">&#34;contract&#34;</span><span class="o">,</span> <span class="s">&#34;paperless_billing&#34;</span><span class="o">,</span> <span class="s">&#34;payment_method&#34;</span><span class="o">,</span> <span class="s">&#34;churn&#34;</span><span class="o">)</span>

<span class="n">sparkDf</span> <span class="k">=</span> <span class="n">sparkDf</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&#34;total_charges&#34;</span><span class="o">,</span> <span class="n">$</span><span class="s">&#34;total_charges&#34;</span><span class="o">.</span><span class="n">cast</span><span class="o">(</span><span class="nc">DoubleType</span><span class="o">)).</span><span class="n">na</span><span class="o">.</span><span class="n">fill</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>

<span class="k">var</span> <span class="n">stages</span> <span class="k">=</span> <span class="nc">List</span><span class="o">[</span><span class="kt">StringIndexer</span><span class="o">]()</span> <span class="c1">// stages in our Pipeline
</span><span class="c1"></span><span class="k">var</span> <span class="n">outputCols</span> <span class="k">=</span> <span class="nc">List</span><span class="o">((</span><span class="s">&#34;customer_id&#34;</span><span class="o">,</span> <span class="s">&#34;customer_id&#34;</span><span class="o">))</span>

<span class="k">for</span> <span class="o">(</span><span class="n">categoricalCol</span> <span class="k">&lt;-</span> <span class="n">categoricalColumns</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// Category Indexing with StringIndexer
</span><span class="c1"></span>    <span class="k">val</span> <span class="n">outputCol</span> <span class="k">=</span> <span class="n">categoricalCol</span> <span class="o">+</span> <span class="s">&#34;_index&#34;</span>
    <span class="k">val</span> <span class="n">stringIndexer</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StringIndexer</span><span class="o">()</span>
    <span class="n">stringIndexer</span><span class="o">.</span><span class="n">setInputCol</span><span class="o">(</span><span class="n">categoricalCol</span><span class="o">)</span>
    <span class="n">stringIndexer</span><span class="o">.</span><span class="n">setOutputCol</span><span class="o">(</span><span class="n">outputCol</span><span class="o">)</span>
    
    <span class="n">stages</span> <span class="k">=</span> <span class="n">stringIndexer</span> <span class="k">:</span><span class="kt">:</span> <span class="kt">stages</span>
    <span class="n">outputCols</span> <span class="k">=</span> <span class="o">(</span><span class="n">categoricalCol</span><span class="o">,</span> <span class="n">outputCol</span><span class="o">)</span> <span class="k">:</span><span class="kt">:</span> <span class="kt">outputCols</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">pipeline</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Pipeline</span><span class="o">().</span><span class="n">setStages</span><span class="o">(</span><span class="n">stages</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span>
<span class="k">val</span> <span class="n">dataset</span> <span class="k">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="o">(</span><span class="n">sparkDf</span><span class="o">).</span><span class="n">transform</span><span class="o">(</span><span class="n">sparkDf</span><span class="o">)</span>
<span class="k">val</span> <span class="n">telcoFgDf</span> <span class="k">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">selectExpr</span><span class="o">(</span><span class="n">outputCols</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">oc</span> <span class="k">=&gt;</span> <span class="n">oc</span><span class="o">.</span><span class="n">_1</span>  <span class="o">+</span> <span class="s">&#34; as &#34;</span> <span class="o">+</span> <span class="n">oc</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span><span class="k">:_</span><span class="kt">*</span><span class="o">)</span></code></pre></div>
<pre><code>categoricalColumns: Seq[String] = List(gender, senior_citizen, partner, dependents, phone_service, multiple_lines, internet_service, online_security, online_backup, device_protection, tech_support, streaming_tv, streaming_movies, contract, paperless_billing, payment_method, churn)
sparkDf: org.apache.spark.sql.Dataset[org.apache.spark.sql.Row] = [customer_id: string, gender: string ... 19 more fields]
stages: List[org.apache.spark.ml.feature.StringIndexer] = List()
outputCols: List[(String, String)] = List((customer_id,customer_id))
pipeline: org.apache.spark.ml.Pipeline = pipeline_3f1d5b001461
dataset: org.apache.spark.sql.DataFrame = [customer_id: string, gender: string ... 36 more fields]
telcoFgDf: org.apache.spark.sql.DataFrame = [churn_index: string, payment_method_index: string ... 16 more fields]
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="n">telcoFgDf</span><span class="o">.</span><span class="n">show</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span></code></pre></div>
<pre><code>+-----------+--------------------+-----------------------+--------------+----------------------+------------------+------------------+-----------------------+-------------------+---------------------+----------------------+--------------------+-------------------+----------------+-------------+--------------------+------------+-----------+
|churn_index|payment_method_index|paperless_billing_index|contract_index|streaming_movies_index|streaming_tv_index|tech_support_index|device_protection_index|online_backup_index|online_security_index|internet_service_index|multiple_lines_index|phone_service_index|dependents_index|partner_index|senior_citizen_index|gender_index|customer_id|
+-----------+--------------------+-----------------------+--------------+----------------------+------------------+------------------+-----------------------+-------------------+---------------------+----------------------+--------------------+-------------------+----------------+-------------+--------------------+------------+-----------+
|         No|    Electronic check|                    Yes|Month-to-month|                    No|                No|                No|                     No|                Yes|                   No|                   DSL|    No phone service|                 No|              No|          Yes|                   0|      Female| 7590-VHVEG|
|         No|        Mailed check|                     No|      One year|                    No|                No|                No|                    Yes|                 No|                  Yes|                   DSL|                  No|                Yes|              No|           No|                   0|        Male| 5575-GNVDE|
|        Yes|        Mailed check|                    Yes|Month-to-month|                    No|                No|                No|                     No|                Yes|                  Yes|                   DSL|                  No|                Yes|              No|           No|                   0|        Male| 3668-QPYBK|
|         No|Bank transfer (au...|                     No|      One year|                    No|                No|               Yes|                    Yes|                 No|                  Yes|                   DSL|    No phone service|                 No|              No|           No|                   0|        Male| 7795-CFOCW|
|        Yes|    Electronic check|                    Yes|Month-to-month|                    No|                No|                No|                     No|                 No|                   No|           Fiber optic|                  No|                Yes|              No|           No|                   0|      Female| 9237-HQITU|
+-----------+--------------------+-----------------------+--------------+----------------------+------------------+------------------+-----------------------+-------------------+---------------------+----------------------+--------------------+-------------------+----------------+-------------+--------------------+------------+-----------+
only showing top 5 rows
</code></pre>

<p>Storing feature groups as cached feature groups within Hopsworks provides several benefits over on-demand feature groups. First it allows users to leverage Hudi for incremental ingestion (with ACID properties, ensuring the integrity of the feature group) and time travel capabilities. As new data is ingested, new commits are tracked by Hopsworks allowing users to see what has changed over time. On each commit, statistics are computed and tracked in Hopsworks, allowing users to understand how the data has changed over time.</p>

<p>Cached feature groups can also be stored in the online feature store (<code>online_enabled=True</code>), thus enabling low latency access to the features using the online feature store API.</p>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="n">telcoFg</span> <span class="k">=</span> <span class="o">(</span><span class="n">fs</span><span class="o">.</span><span class="n">createFeatureGroup</span><span class="o">()</span>
                 <span class="o">.</span><span class="n">name</span><span class="o">(</span><span class="s">&#34;telco_customer_features&#34;</span><span class="o">)</span>
                 <span class="o">.</span><span class="n">version</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
                 <span class="o">.</span><span class="n">description</span><span class="o">(</span><span class="s">&#34;Telecom customer features&#34;</span><span class="o">)</span>
                 <span class="o">.</span><span class="n">onlineEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                 <span class="o">.</span><span class="n">timeTravelFormat</span><span class="o">(</span><span class="nc">TimeTravelFormat</span><span class="o">.</span><span class="nc">HUDI</span><span class="o">)</span>
                 <span class="o">.</span><span class="n">primaryKeys</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span><span class="s">&#34;customer_id&#34;</span><span class="o">))</span>
                 <span class="o">.</span><span class="n">statisticsEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                 <span class="o">.</span><span class="n">build</span><span class="o">())</span></code></pre></div>
<pre><code>telcoFg: com.logicalclocks.hsfs.FeatureGroup = com.logicalclocks.hsfs.FeatureGroup@6927f5b8
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-scala" data-lang="scala"><span class="n">telcoFg</span><span class="o">.</span><span class="n">save</span><span class="o">(</span><span class="n">telcoFgDf</span><span class="o">)</span></code></pre></div>
    </div>
    <aside>
      <div class="bug_reporting">
	<h4>Find an error or bug?</h4>
	<p>Everything on this site is available on GitHub. Head to <a href='https://github.com/chrisalbon/notes/issues/new'>and submit a suggested change</a>. Include the tutorial's URL in the issue.</p>
      </div>
    </aside>

  </div>
</article>




            </div>

        </div>
    </div>

    

    <footer class="footer text-center">
        <div class="container">
            <span class="text-muted">This project contains 59 pages and is available on <a href="https://github.com/napsterinblue/notes">GitHub</a>. Copyright &copy; NapsterInBlue, <time datetime="2018">2018</time>.</span>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>

</body>

</html>
