<!DOCTYPE html>
<html lang="en">

<head>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66582-32"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-66582-32');
    </script>

    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Databricks Feature AWS Store Quickstart" />
<meta property="og:description" content="Databricks AWS Feature Store Quick Start This notebook gives you a quick overview of how you can intergrate the Feature Store on Hopsworks with Databricks and S3. We&rsquo;ll go over four steps:
 Generate some sample data and store it on S3 Do some feature engineering with Databricks and the data from S3 Save the engineered features to the Feature Store Select a group of the features from the Feature Store and create a training dataset of tf records stored on S3  This requries configuring the Databricks cluster to be able to interact with Hopsworks Feature Store, see Databricks Quick Start." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://examples.hopsworks.ai/featurestore/databricks/featurestorequickstartdatabricksaws/" />



<meta property="article:published_time" content="2021-02-24T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2021-02-24T00:00:00&#43;00:00"/>











<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Databricks Feature AWS Store Quickstart"/>
<meta name="twitter:description" content="Databricks AWS Feature Store Quick Start This notebook gives you a quick overview of how you can intergrate the Feature Store on Hopsworks with Databricks and S3. We&rsquo;ll go over four steps:
 Generate some sample data and store it on S3 Do some feature engineering with Databricks and the data from S3 Save the engineered features to the Feature Store Select a group of the features from the Feature Store and create a training dataset of tf records stored on S3  This requries configuring the Databricks cluster to be able to interact with Hopsworks Feature Store, see Databricks Quick Start."/>
<meta name="generator" content="Hugo 0.40.3" />

    
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Databricks Feature AWS Store Quickstart",
  "url": "https://examples.hopsworks.ai/featurestore/databricks/featurestorequickstartdatabricksaws/",
  "wordCount": "954",
  "datePublished": "2021-02-24T00:00:00&#43;00:00",
  "dateModified": "2021-02-24T00:00:00&#43;00:00",
  "author": {
  "@type": "Person",
  "name": ""
  }
  }
</script> 

    <title>Databricks Feature AWS Store Quickstart</title>

    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">

    
    <link href="https://examples.hopsworks.ai/css/custom.css" rel="stylesheet">
    <link href="https://examples.hopsworks.ai/css/syntax.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli:400,500,700" rel="stylesheet">

    <link href="" rel="alternate" type="application/rss+xml" title="Hopsworks Examples" />

    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</head>

<body>

    <nav class="navbar navbar-expand-sm fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="https://examples.hopsworks.ai">Hopsworks Examples</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="nav navbar-nav mr-auto"></ul>
                <ul class="nav navbar-nav">
                    <li><a href="https://hopsworks.ai" title="Hopsworks.ai">hopsworks.ai</a></li>
                    <li><a href="https://docs.hopsworks.ai" title="Docs">docs.hopsworks.ai</a></li>
                </ul>
            </div>
        </div>
    </nav>


    
    <div class="container">
        <div class="row">
            <div class="col-sm-12">

                 


<article>
  <div class="technical_note">
    <header>
      <div class="alert alert-warning flashcard_ad" role="alert">
	Want to learn machine learning? Try my <a href="https://machinelearningflashcards.com" class="alert-link">machine learning flashcards</a>, <a href='https://amzn.to/2HwnWty' class="alert-link">book</a>, or <a href='https://www.youtube.com/channel/UCnd4Fi-ODvuPbxR2fO2j7kA' class="alert-link">study with me.</a>.
      </div>
      <h1 class="technical_note_title">Databricks Feature AWS Store Quickstart</h1>
      <div class="technical_note_date">
	<time datetime=" 2021-02-24T00:00:00Z "> 24 Feb 2021</time>
      </div>
    </header>
    <div class="content">

      

<h1 id="databricks-aws-feature-store-quick-start">Databricks AWS Feature Store Quick Start</h1>

<p>This notebook gives you a quick overview of how you can intergrate the Feature Store on Hopsworks with Databricks and S3. We&rsquo;ll go over four steps:</p>

<ol>
<li>Generate some sample data and store it on S3</li>
<li>Do some feature engineering with Databricks and the data from S3</li>
<li><strong>Save the engineered features to the Feature Store</strong></li>
<li><strong>Select a group of the features from the Feature Store and create a training dataset of tf records stored on S3</strong></li>
</ol>

<p><strong>This requries configuring the Databricks cluster to be able to interact with Hopsworks Feature Store, see <a href="https://docs.hopsworks.ai/integrations/databricks/configuration/">Databricks Quick Start</a>.</strong></p>

<h2 id="imports">Imports</h2>

<p>We&rsquo;ll use numpy and pandas for data generation, pyspark for feature engineering, tensorflow and keras for model training, and the <code>hsfs</code> library to interact with the Hopsworks Feature Store.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">hsfs</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SQLContext</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Row</span>
<span class="n">sqlContext</span> <span class="o">=</span> <span class="n">SQLContext</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span></code></pre></div>
<h2 id="connecting-to-the-feature-store">Connecting to the Feature Store</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Connect to the feature store, see https://docs.hopsworks.ai/generated/api/connection_api/#connection_1 for more information</span>
<span class="c1"># On AWS secrets can be stored also on the Secrets Manager or Parameter Store.</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">hsfs</span><span class="o">.</span><span class="n">connection</span><span class="p">(</span>
  <span class="n">host</span><span class="o">=</span><span class="s2">&#34;10.0.0.247&#34;</span><span class="p">,</span>
  <span class="n">project</span><span class="o">=</span><span class="s2">&#34;dataai&#34;</span><span class="p">,</span>
  <span class="n">port</span><span class="o">=</span><span class="s2">&#34;443&#34;</span><span class="p">,</span>
  <span class="n">api_key_value</span><span class="o">=</span><span class="s2">&#34;pduNksE2VMuSYdCY.K4AsDoxMBX5luisgb3pB7FimpEO7iyOuYvLPqWQcnXUs51RlBrLyAYXpKDoWH9Cm&#34;</span><span class="p">,</span>
  <span class="n">hostname_verification</span><span class="o">=</span><span class="bp">False</span>
<span class="p">)</span>

<span class="n">fs</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">get_feature_store</span><span class="p">()</span></code></pre></div>
<h2 id="mounting-an-s3-bucket-to-databricks">Mounting an S3 bucket to Databricks</h2>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Mount a bucket so that we can simulate a Datalake based on S3</span>
<span class="c1"># This requires IAM roles to be set up for Databricks, see https://docs.databricks.com/data/data-sources/aws/amazon-s3.html#access-s3-buckets-directly</span>
<span class="n">AWS_BUCKET_NAME</span> <span class="o">=</span> <span class="s2">&#34;steffendatabricks&#34;</span> <span class="c1"># Ensure to replace with your bucket</span>
<span class="n">MOUNT_NAME</span> <span class="o">=</span> <span class="s2">&#34;/mnt/demo_db_hsfs&#34;</span>
<span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s2">&#34;s3a://</span><span class="si">%s</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="n">AWS_BUCKET_NAME</span><span class="p">,</span> <span class="n">MOUNT_NAME</span><span class="p">)</span></code></pre></div>
<h2 id="generate-sample-data">Generate Sample Data</h2>

<p>Lets generate two sample datasets and store them on S3:</p>

<ol>
<li><code>houses_for_sale_data</code>:</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">+-------+--------+------------------+------------------+------------------+
<span class="p">|</span>area_id<span class="p">|</span>house_id<span class="p">|</span>       house_worth<span class="p">|</span>         house_age<span class="p">|</span>        house_size<span class="p">|</span>
+-------+--------+------------------+------------------+------------------+
<span class="p">|</span>      <span class="m">1</span><span class="p">|</span>       <span class="m">0</span><span class="p">|</span> <span class="m">11678</span>.15482418699<span class="p">|</span><span class="m">133</span>.88670106643886<span class="p">|</span><span class="m">366</span>.80067322738535<span class="p">|</span>
<span class="p">|</span>      <span class="m">1</span><span class="p">|</span>       <span class="m">1</span><span class="p">|</span> <span class="m">2290</span>.436167500643<span class="p">|</span><span class="m">15994</span>.969706808222<span class="p">|</span><span class="m">195</span>.84014889823976<span class="p">|</span>
<span class="p">|</span>      <span class="m">1</span><span class="p">|</span>       <span class="m">2</span><span class="p">|</span> <span class="m">8380</span>.774578431328<span class="p">|</span><span class="m">1994</span>.8576926471007<span class="p">|</span><span class="m">1544</span>.5164614303735<span class="p">|</span>
<span class="p">|</span>      <span class="m">1</span><span class="p">|</span>       <span class="m">3</span><span class="p">|</span><span class="m">11641</span>.224696102923<span class="p">|</span><span class="m">23104</span>.501275562343<span class="p">|</span><span class="m">1673</span>.7222604337876<span class="p">|</span>
<span class="p">|</span>      <span class="m">1</span><span class="p">|</span>       <span class="m">4</span><span class="p">|</span> <span class="m">5382</span>.089422436954<span class="p">|</span> <span class="m">13903</span>.43637058141<span class="p">|</span> <span class="m">274</span>.2912104765028<span class="p">|</span>
+-------+--------+------------------+------------------+------------------+

 <span class="p">|</span>-- area_id: long <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- house_id: long <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- house_worth: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- house_age: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- house_size: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span></code></pre></div>
<ol>
<li><code>houses_sold_data</code><code>
</code>``bash
+&mdash;&mdash;-+&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|area_id|house_purchase_id|number_of_bidders|   sold_for_amount|
+&mdash;&mdash;-+&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+
|      1|                0|                0| 70073.06059070028|
|      1|                1|               15| 146.9198329740602|
|      1|                2|                6|  594.802165433149|
|      1|                3|               10| 77187.84123130841|
|      1|                4|                1|110627.48922722359|
+&mdash;&mdash;-+&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;+&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;+</li>
</ol>

<p>|&ndash; area_id: long (nullable = true)
 |&ndash; house_purchase_id: long (nullable = true)
 |&ndash; number_of_bidders: long (nullable = true)
 |&ndash; sold_for_amount: double (nullable = true)</p>

<pre><code>
We'll use this data for predicting what a house is sold for based on features about the **area** where the house is.

### Generation of `houses_for_sale_data`


```python
area_ids = list(range(1,51))
house_sizes = []
house_worths = []
house_ages = []
house_area_ids = []
for i in area_ids:
    for j in list(range(1,100)):
        house_sizes.append(abs(np.random.normal()*1000)/i)
        house_worths.append(abs(np.random.normal()*10000)/i)
        house_ages.append(abs(np.random.normal()*10000)/i)
        house_area_ids.append(i)
house_ids = list(range(len(house_area_ids)))
houses_for_sale_data  = pd.DataFrame({
        'area_id':house_area_ids,
        'house_id':house_ids,
        'house_worth': house_worths,
        'house_age': house_ages,
        'house_size': house_sizes
    })
houses_for_sale_data_spark_df = sqlContext.createDataFrame(houses_for_sale_data)
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">houses_for_sale_data_spark_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">houses_for_sale_data_spark_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">houses_for_sale_data_spark_df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">/houses_for_sale.parquet&#34;</span> <span class="o">%</span> <span class="n">MOUNT_NAME</span><span class="p">)</span></code></pre></div>
<h3 id="generation-of-houses-sold-data">Generation of <code>houses_sold_data</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">house_purchased_amounts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">house_purchases_bidders</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">house_purchases_area_ids</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">area_ids</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">)):</span>
        <span class="n">house_purchased_amounts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">()</span><span class="o">*</span><span class="mi">100000</span><span class="p">)</span><span class="o">/</span><span class="n">i</span><span class="p">)</span>
        <span class="n">house_purchases_bidders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">()</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="n">i</span><span class="p">))</span>
        <span class="n">house_purchases_area_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">house_purchase_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">house_purchases_bidders</span><span class="p">)))</span>
<span class="n">houses_sold_data</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;area_id&#39;</span><span class="p">:</span><span class="n">house_purchases_area_ids</span><span class="p">,</span>
        <span class="s1">&#39;house_purchase_id&#39;</span><span class="p">:</span><span class="n">house_purchase_ids</span><span class="p">,</span>
        <span class="s1">&#39;number_of_bidders&#39;</span><span class="p">:</span> <span class="n">house_purchases_bidders</span><span class="p">,</span>
        <span class="s1">&#39;sold_for_amount&#39;</span><span class="p">:</span> <span class="n">house_purchased_amounts</span>
    <span class="p">})</span>
<span class="n">houses_sold_data_spark_df</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">houses_sold_data</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">houses_sold_data_spark_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">houses_sold_data_spark_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">houses_sold_data_spark_df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;parquet&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">/houses_sold.parquet&#34;</span> <span class="o">%</span> <span class="n">MOUNT_NAME</span><span class="p">)</span></code></pre></div>
<h2 id="feature-engineering">Feature Engineering</h2>

<p>Lets generate some aggregate features such as sum and averages from our datasets on S3.</p>

<ol>
<li><code>houses_for_sale_features</code>:</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"> <span class="p">|</span>-- area_id: long <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- avg_house_age: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- avg_house_size: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- avg_house_worth: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- sum_house_age: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- sum_house_size: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- sum_house_worth: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span></code></pre></div>
<ol>
<li><code>houses_sold_features</code></li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"> <span class="p">|</span>-- area_id: long <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- avg_num_bidders: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- avg_sold_for: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- sum_number_of_bidders: long <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span>
 <span class="p">|</span>-- sum_sold_for_amount: double <span class="o">(</span><span class="nv">nullable</span> <span class="o">=</span> <span class="nb">true</span><span class="o">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">display</span><span class="p">(</span><span class="n">dbutils</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">MOUNT_NAME</span><span class="p">))</span></code></pre></div>
<h3 id="generate-features-from-houses-for-sale-data">Generate Features From <code>houses_for_sale_data</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">houses_for_sale_data_spark_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">/houses_for_sale.parquet&#34;</span> <span class="o">%</span> <span class="n">MOUNT_NAME</span><span class="p">)</span>
<span class="n">sum_houses_for_sale_df</span> <span class="o">=</span> <span class="n">houses_for_sale_data_spark_df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;area_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="n">count_houses_for_sale_df</span> <span class="o">=</span> <span class="n">houses_for_sale_data_spark_df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;area_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">sum_count_houses_for_sale_df</span> <span class="o">=</span> <span class="n">sum_houses_for_sale_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">count_houses_for_sale_df</span><span class="p">,</span> <span class="s2">&#34;area_id&#34;</span><span class="p">)</span>
<span class="n">sum_count_houses_for_sale_df</span> <span class="o">=</span> <span class="n">sum_count_houses_for_sale_df</span> \
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;sum(house_age)&#34;</span><span class="p">,</span> <span class="s2">&#34;sum_house_age&#34;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;sum(house_worth)&#34;</span><span class="p">,</span> <span class="s2">&#34;sum_house_worth&#34;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;sum(house_size)&#34;</span><span class="p">,</span> <span class="s2">&#34;sum_house_size&#34;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">,</span> <span class="s2">&#34;num_rows&#34;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_average_features_house_for_sale</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">avg_house_worth</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">sum_house_worth</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">num_rows</span><span class="p">)</span>
    <span class="n">avg_house_size</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">sum_house_size</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">num_rows</span><span class="p">)</span>
    <span class="n">avg_house_age</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">sum_house_age</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">num_rows</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Row</span><span class="p">(</span>
        <span class="n">sum_house_worth</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">sum_house_worth</span><span class="p">,</span> 
        <span class="n">sum_house_age</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">sum_house_age</span><span class="p">,</span>
        <span class="n">sum_house_size</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">sum_house_size</span><span class="p">,</span>
        <span class="n">area_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">area_id</span><span class="p">,</span>
        <span class="n">avg_house_worth</span> <span class="o">=</span> <span class="n">avg_house_worth</span><span class="p">,</span>
        <span class="n">avg_house_size</span> <span class="o">=</span> <span class="n">avg_house_size</span><span class="p">,</span>
        <span class="n">avg_house_age</span> <span class="o">=</span> <span class="n">avg_house_age</span>
       <span class="p">)</span>
<span class="n">houses_for_sale_features_df</span> <span class="o">=</span> <span class="n">sum_count_houses_for_sale_df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">compute_average_features_house_for_sale</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">houses_for_sale_features_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></code></pre></div>
<h3 id="generate-features-from-houses-sold-data">Generate Features from <code>houses_sold_data</code></h3>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">houses_sold_data_spark_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">%s</span><span class="s2">/houses_sold.parquet&#34;</span> <span class="o">%</span> <span class="n">MOUNT_NAME</span><span class="p">)</span>
<span class="n">sum_houses_sold_df</span> <span class="o">=</span> <span class="n">houses_sold_data_spark_df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;area_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="n">count_houses_sold_df</span> <span class="o">=</span> <span class="n">houses_sold_data_spark_df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;area_id&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">sum_count_houses_sold_df</span> <span class="o">=</span> <span class="n">sum_houses_sold_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">count_houses_sold_df</span><span class="p">,</span> <span class="s2">&#34;area_id&#34;</span><span class="p">)</span>
<span class="n">sum_count_houses_sold_df</span> <span class="o">=</span> <span class="n">sum_count_houses_sold_df</span> \
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;sum(number_of_bidders)&#34;</span><span class="p">,</span> <span class="s2">&#34;sum_number_of_bidders&#34;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;sum(sold_for_amount)&#34;</span><span class="p">,</span> <span class="s2">&#34;sum_sold_for_amount&#34;</span><span class="p">)</span> \
    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;count&#34;</span><span class="p">,</span> <span class="s2">&#34;num_rows&#34;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compute_average_features_houses_sold</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">avg_num_bidders</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">sum_number_of_bidders</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">num_rows</span><span class="p">)</span>
    <span class="n">avg_sold_for</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">sum_sold_for_amount</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">num_rows</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Row</span><span class="p">(</span>
        <span class="n">sum_number_of_bidders</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">sum_number_of_bidders</span><span class="p">,</span> 
        <span class="n">sum_sold_for_amount</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">sum_sold_for_amount</span><span class="p">,</span>
        <span class="n">area_id</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">area_id</span><span class="p">,</span>
        <span class="n">avg_num_bidders</span> <span class="o">=</span> <span class="n">avg_num_bidders</span><span class="p">,</span>
        <span class="n">avg_sold_for</span> <span class="o">=</span> <span class="n">avg_sold_for</span>
       <span class="p">)</span>
<span class="n">houses_sold_features_df</span> <span class="o">=</span> <span class="n">sum_count_houses_sold_df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">compute_average_features_houses_sold</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">houses_sold_features_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span></code></pre></div>
<h2 id="save-features-to-the-feature-store">Save Features to the Feature Store</h2>

<p>The Featue store has an abstraction of a <strong>feature group</strong> which is a set of features that naturally belong together that are computed using the same feature engineering job.</p>

<p>Lets create two feature groups:</p>

<ol>
<li><p><code>houses_for_sale_featuregroup</code></p></li>

<li><p><code>houses_sold_featuregroup</code></p></li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Refer to https://docs.hopsworks.ai/generated/api/feature_store_api/#create_feature_group for the different parameters for creating a feature group</span>
<span class="n">house_sale_fg</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_feature_group</span><span class="p">(</span><span class="s2">&#34;houses_for_sale_featuregroup&#34;</span><span class="p">,</span>
                       <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">description</span><span class="o">=</span><span class="s2">&#34;aggregate features of houses for sale per area&#34;</span><span class="p">,</span>
                       <span class="n">primary_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;area_id&#39;</span><span class="p">],</span>
                       <span class="n">online_enabled</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                       <span class="n">time_travel_format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">statistics_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;histograms&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&#34;correlations&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

<span class="n">house_sale_fg</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">houses_for_sale_features_df</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">house_sold_fg</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_feature_group</span><span class="p">(</span><span class="s2">&#34;houses_sold_featuregroup&#34;</span><span class="p">,</span>
                       <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">description</span><span class="o">=</span><span class="s2">&#34;aggregate features of sold houses per area&#34;</span><span class="p">,</span>
                       <span class="n">primary_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;area_id&#39;</span><span class="p">],</span>
                       <span class="n">online_enabled</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                       <span class="n">time_travel_format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">statistics_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;histograms&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&#34;correlations&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

<span class="n">house_sold_fg</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">houses_sold_features_df</span><span class="p">)</span></code></pre></div>
<h2 id="create-a-training-dataset">Create a Training Dataset</h2>

<p>The feature store has an abstraction of a <strong>training dataset</strong>, which is a dataset with a set of features (potentially from many different feature groups) and labels (in case of supervised learning) stored in a ML Framework friendly format (CSV, Tfrecords, &hellip;)</p>

<p>Let&rsquo;s create a training dataset called <em>predict_house_sold_for_dataset</em> using the following features:</p>

<ul>
<li><code>avg_house_age</code></li>
<li><code>avg_house_size</code></li>
<li><code>avg_house_worth</code></li>
<li><code>avg_num_bidders</code></li>
</ul>

<p>and the target variable is:</p>

<ul>
<li><code>avg_sold_for</code></li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Get the metadata for the storage connector from the Feature store.</span>
<span class="n">s3_bucket</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_storage_connector</span><span class="p">(</span><span class="s2">&#34;house_model_data&#34;</span><span class="p">,</span> <span class="s2">&#34;S3&#34;</span><span class="p">)</span>

<span class="c1"># Join features and feature groups to create the training dataset</span>
<span class="n">feature_query</span> <span class="o">=</span> <span class="n">house_sale_fg</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&#34;avg_house_age&#34;</span><span class="p">,</span> <span class="s2">&#34;avg_house_size&#34;</span><span class="p">,</span> <span class="s2">&#34;avg_house_worth&#34;</span><span class="p">])</span>\
                            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">house_sold_fg</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&#34;avg_num_bidders&#34;</span><span class="p">,</span> <span class="s2">&#34;avg_sold_for&#34;</span><span class="p">]))</span>
  
<span class="c1"># Create the training dataset metadata</span>
<span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;predict_house_sold_for_dataset_two&#34;</span><span class="p">,</span>
                           <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                           <span class="n">data_format</span><span class="o">=</span><span class="s2">&#34;csv&#34;</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;avg_sold_for&#39;</span><span class="p">],</span>
                           <span class="n">storage_connector</span><span class="o">=</span><span class="n">s3_bucket</span><span class="p">,</span>
                           <span class="n">statistics_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;histograms&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&#34;correlations&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

<span class="c1"># Save the training dataset</span>
<span class="n">td</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">feature_query</span><span class="p">)</span></code></pre></div>
<style scoped>
  .ansiout {
    display: block;
    unicode-bidi: embed;
    white-space: pre-wrap;
    word-wrap: break-word;
    word-break: break-all;
    font-family: "Source Code Pro", "Menlo", monospace;;
    font-size: 13px;
    color: #555;
    margin-left: 4px;
    line-height: 19px;
  }
</style>

    </div>
    <aside>
      <div class="bug_reporting">
	<h4>Find an error or bug?</h4>
	<p>Everything on this site is available on GitHub. Head to <a href='https://github.com/chrisalbon/notes/issues/new'>and submit a suggested change</a>. Include the tutorial's URL in the issue.</p>
      </div>
    </aside>

  </div>
</article>




            </div>

        </div>
    </div>

    

    <footer class="footer text-center">
        <div class="container">
            <span class="text-muted">This project contains 59 pages and is available on <a href="https://github.com/napsterinblue/notes">GitHub</a>. Copyright &copy; NapsterInBlue, <time datetime="2018">2018</time>.</span>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>

</body>

</html>
