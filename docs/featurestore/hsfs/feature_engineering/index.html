<!DOCTYPE html>
<html lang="en">

<head>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66582-32"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-66582-32');
    </script>

    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Hsfs - Feature Engineering" />
<meta property="og:description" content="Feature Store Tour - Python API This set of notebooks contain a tour/reference for the Hopsworks feature store Scala/Java API. The notebook is meant to be run from feature store demo projects on Hopsworks. We will go over best practices for using the API as well as common pitfalls.
There are 3 notebooks: - Feature groups: Discover how to work with features and feature groups, both offline and online - Feature Exploration: Discover how to join features from different feature groups - Training datasets: Discover how to save training datasets to be used by ML models" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://examples.hopsworks.ai/featurestore/hsfs/feature_engineering/" />



<meta property="article:published_time" content="2021-02-24T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2021-02-24T00:00:00&#43;00:00"/>











<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hsfs - Feature Engineering"/>
<meta name="twitter:description" content="Feature Store Tour - Python API This set of notebooks contain a tour/reference for the Hopsworks feature store Scala/Java API. The notebook is meant to be run from feature store demo projects on Hopsworks. We will go over best practices for using the API as well as common pitfalls.
There are 3 notebooks: - Feature groups: Discover how to work with features and feature groups, both offline and online - Feature Exploration: Discover how to join features from different feature groups - Training datasets: Discover how to save training datasets to be used by ML models"/>
<meta name="generator" content="Hugo 0.40.3" />

    
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Hsfs - Feature Engineering",
  "url": "https://examples.hopsworks.ai/featurestore/hsfs/feature_engineering/",
  "wordCount": "1597",
  "datePublished": "2021-02-24T00:00:00&#43;00:00",
  "dateModified": "2021-02-24T00:00:00&#43;00:00",
  "author": {
  "@type": "Person",
  "name": ""
  }
  }
</script> 

    <title>Hsfs - Feature Engineering</title>

    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">

    
    <link href="https://examples.hopsworks.ai/css/custom.css" rel="stylesheet">
    <link href="https://examples.hopsworks.ai/css/syntax.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli:400,500,700" rel="stylesheet">

    <link href="" rel="alternate" type="application/rss+xml" title="Hopsworks Examples" />

    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</head>

<body>

    <nav class="navbar navbar-expand-sm fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="https://examples.hopsworks.ai">Hopsworks Examples</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="nav navbar-nav mr-auto"></ul>
                <ul class="nav navbar-nav">
                    <li><a href="https://hopsworks.ai" title="Hopsworks.ai">hopsworks.ai</a></li>
                    <li><a href="https://docs.hopsworks.ai" title="Docs">docs.hopsworks.ai</a></li>
                </ul>
            </div>
        </div>
    </nav>


    
    <div class="container">
        <div class="row">
            <div class="col-sm-12">

                 


<article>
  <div class="technical_note">
    <header>
      <div class="alert alert-warning flashcard_ad" role="alert">
	Want to learn machine learning? Try my <a href="https://machinelearningflashcards.com" class="alert-link">machine learning flashcards</a>, <a href='https://amzn.to/2HwnWty' class="alert-link">book</a>, or <a href='https://www.youtube.com/channel/UCnd4Fi-ODvuPbxR2fO2j7kA' class="alert-link">study with me.</a>.
      </div>
      <h1 class="technical_note_title">Hsfs - Feature Engineering</h1>
      <div class="technical_note_date">
	<time datetime=" 2021-02-24T00:00:00Z "> 24 Feb 2021</time>
      </div>
    </header>
    <div class="content">

      

<h1 id="feature-store-tour-python-api">Feature Store Tour - Python API</h1>

<p>This set of notebooks contain a tour/reference for the Hopsworks feature store Scala/Java API. The notebook is meant to be run from feature store demo projects on Hopsworks. We will go over best practices for using the API as well as common pitfalls.</p>

<p>There are 3 notebooks:
- Feature groups: Discover how to work with features and feature groups, both offline and online
- <a href="./feature_exploration.ipynb">Feature Exploration</a>: Discover how to join features from different feature groups
- <a href="./training_datasets.ipynb">Training datasets</a>: Discover how to save training datasets to be used by ML models</p>

<p>The data required to run this tour is located in a zip file called <code>archive.zip</code> in the same directory as the notebooks. Head to the Dataset browser on Hopsworks and unzip it.</p>

<h2 id="features-and-feature-groups">Features and Feature Groups</h2>

<p>The Hopsworks feature store is a centralized repository, within an organization, to manage machine learning features. A feature is a measurable property of a phenomenon. It could be a simple value such as the age of a customer, or it could be an aggregated value, such as the number of transactions made by a customer in the last 30 days.</p>

<p>A feature is not restricted to an numeric value, it could be a string representing an address, or an image.</p>

<p><img src="overview.svg" alt="Feature Store Overview" title="Feature Store Overview" /></p>

<p>A feature store is not a pure storage service, it goes hand-in-hand with feature computation. Feature engineering is the process of transforming raw data into a format that is compatible and understandable for predictive models.</p>

<p>In this notebook we are going to focus on the left side of the picture above. In particular how data engeneers can create features and push them to the Hopsworks feature store so that they are available to the data scientists</p>

<h3 id="hsfs-library">HSFS library</h3>

<p>The Hopsworks feature feature store library is called <code>hsfs</code> (<strong>H</strong>opswork<strong>s</strong> <strong>F</strong>eature <strong>S</strong>tore).
The library is Apache V2 licensed and available <a href="https://github.com/logicalclocks/feature-store-api">here</a>. The library is currently available for Python and JVM languages such as Scala and Java.
In this notebook we are going to cover Python part.</p>

<p>You can find the complete documentation of the library here:</p>

<p>The first step is to establish a connection with your Hopsworks feature store instance and retrieve the object that represents the feature store you&rsquo;ll be working with.</p>

<p>By default <code>connection.get_feature_store()</code> returns the feature store of the project you are working with. However, it accepts also a project name as parameter to select a different feature store.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">hsfs</span>
<span class="c1"># Create a connection</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">hsfs</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span>
<span class="c1"># Get the feature store handle for the project&#39;s feature store</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">get_feature_store</span><span class="p">()</span></code></pre></div>
<pre><code>Starting Spark application
</code></pre>

<table>
<tr><th>ID</th><th>YARN Application ID</th><th>Kind</th><th>State</th><th>Spark UI</th><th>Driver log</th></tr><tr><td>7</td><td>application_1605286520909_0013</td><td>pyspark</td><td>idle</td><td><a target="_blank" href="http://resourcemanager.service.consul:8088/proxy/application_1605286520909_0013/">Link</a></td><td><a target="_blank" href="http://ip-10-0-0-114.us-west-2.compute.internal:8042/node/containerlogs/container_e02_1605286520909_0013_01_000001/demo_fs_meb10179__meb10179">Link</a></td></tr></table>

<pre><code>SparkSession available as 'spark'.
Connected. Call `.close()` to terminate connection gracefully.
</code></pre>

<h2 id="data-engineering">Data Engineering</h2>

<p>We are going to use a dataset containing information related to a chain of deparment stores. The dataset is taken from <a href="https://www.kaggle.com/manjeetsingh/retaildataset?select=Features+data+set.csv">Kaggke</a>.</p>

<p>We are going to create 3 feature groups:
- <code>stores_fg</code>: it&rsquo;s going to contain features related to the store itself. Mainly the category, the number of deparmetns and the size.
- <code>sales_fg</code>: it&rsquo;s going to contain sales features for each store/deparment over the weeks.
- <code>exogenous_fg</code>: it&rsquo;s going to contain features which are not related to the stores themselves, but they have an effect on sales. These features are, for instance, the gas price, the unemployment rate, temperature in the area and so on.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">hops</span> <span class="kn">import</span> <span class="n">hdfs</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>

<span class="n">stores_csv</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span>\
             <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;inferSchema&#34;</span><span class="p">,</span> <span class="s2">&#34;true&#34;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="s2">&#34;true&#34;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;hdfs:///Projects/{}/Jupyter/hsfs/archive/stores data-set.csv&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdfs</span><span class="o">.</span><span class="n">project_name</span><span class="p">()))</span>

<span class="n">exogenous_csv</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span>\
             <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;inferSchema&#34;</span><span class="p">,</span> <span class="s2">&#34;true&#34;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="s2">&#34;true&#34;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;hdfs:///Projects/{}/Jupyter/hsfs/archive/Features data set.csv&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdfs</span><span class="o">.</span><span class="n">project_name</span><span class="p">()))</span>

<span class="n">sales_csv</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span>\
             <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;inferSchema&#34;</span><span class="p">,</span> <span class="s2">&#34;true&#34;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&#34;header&#34;</span><span class="p">,</span> <span class="s2">&#34;true&#34;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&#34;csv&#34;</span><span class="p">)</span>\
             <span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&#34;hdfs:///Projects/{}/Jupyter/hsfs/archive/sales data-set.csv&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdfs</span><span class="o">.</span><span class="n">project_name</span><span class="p">()))</span></code></pre></div>
<h4 id="feature-engineering-stores">Feature Engineering Stores</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">stores_depts_count</span> <span class="o">=</span> <span class="n">stores_csv</span>\
                    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sales_csv</span><span class="p">,</span> <span class="s2">&#34;store&#34;</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&#34;store&#34;</span><span class="p">)</span>\
                    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">countDistinct</span><span class="p">(</span><span class="s2">&#34;dept&#34;</span><span class="p">))</span>\
                    <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&#34;count(DISTINCT dept)&#34;</span><span class="p">,</span> <span class="s2">&#34;num_depts&#34;</span><span class="p">)</span>

<span class="n">stores_fg</span> <span class="o">=</span> <span class="n">stores_csv</span>\
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stores_depts_count</span><span class="p">,</span> <span class="s2">&#34;store&#34;</span><span class="p">)</span></code></pre></div>
<h4 id="create-store-fg-feature-group">Create <code>store_fg</code> feature group</h4>

<p>Create a feature group named <code>store_fg</code>. The store is the primary key uniquely identifying all the remaining features in this feature group.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">store_fg_meta</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_feature_group</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;store_fg&#34;</span><span class="p">,</span>
                                       <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">primary_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">],</span>
                                       <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Store related features&#34;</span><span class="p">,</span>
                                       <span class="n">time_travel_format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                       <span class="n">statistics_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;enabled&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&#34;histograms&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&#34;correlations&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span></code></pre></div>
<p>Up to this point we have just created the metadata object representing the feature group. However, we haven&rsquo;t saved the feature group in the feature store yet. To do so, we can call the method <code>save</code> on the metadata object created in the cell above.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">store_fg_meta</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">stores_fg</span><span class="p">)</span></code></pre></div>
<pre><code>&lt;hsfs.feature_group.FeatureGroup object at 0x7fa6e6d255d0&gt;
</code></pre>

<h4 id="feature-engineering-sales">Feature Engineering Sales</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Window</span>
<span class="n">days</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">86400</span> 

<span class="n">sales_df</span> <span class="o">=</span> <span class="n">sales_csv</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s2">&#34;date&#34;</span><span class="p">,</span> <span class="s1">&#39;dd/MM/yyy&#39;</span><span class="p">))</span>\
                    <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">unix_timestamp</span><span class="p">(</span><span class="s2">&#34;date&#34;</span><span class="p">))</span>

<span class="c1"># Define aggregation window to compute sales performances over the past period of time</span>
<span class="n">last_month_window_store_dep</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">([</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;dept&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;timestamp&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;long&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">rangeBetween</span><span class="p">(</span><span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">),</span> <span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">last_quarter_window_store_dep</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">([</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;dept&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;timestamp&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;long&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">rangeBetween</span><span class="p">(</span><span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">),</span> <span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">last_six_month_window_store_dep</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">([</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;dept&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;timestamp&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;long&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">rangeBetween</span><span class="p">(</span><span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">),</span> <span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">last_year_window_store_dep</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">([</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;dept&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;timestamp&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;long&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">rangeBetween</span><span class="p">(</span><span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">365</span><span class="p">),</span> <span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="n">last_month_window_store</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;timestamp&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;long&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">rangeBetween</span><span class="p">(</span><span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">30</span><span class="p">),</span> <span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">last_quarter_window_store</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;timestamp&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;long&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">rangeBetween</span><span class="p">(</span><span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">),</span> <span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">last_six_month_window_store</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;timestamp&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;long&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">rangeBetween</span><span class="p">(</span><span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">),</span> <span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="n">last_year_window_store</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;timestamp&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;long&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">rangeBetween</span><span class="p">(</span><span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">365</span><span class="p">),</span> <span class="n">days</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Build feature group dataframe</span>
<span class="n">sales_fg</span> <span class="o">=</span> <span class="n">sales_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;sales_last_month_store_dep&#34;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;weekly_sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">last_month_window_store_dep</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;sales_last_quarter_store_dep&#34;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;weekly_sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">last_quarter_window_store_dep</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;sales_last_six_month_store_dep&#34;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;weekly_sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">last_six_month_window_store_dep</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;sales_last_year_store_dep&#34;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;weekly_sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">last_year_window_store_dep</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;sales_last_month_store&#34;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;weekly_sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">last_month_window_store</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;sales_last_quarter_store&#34;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;weekly_sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">last_quarter_window_store</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;sales_last_six_month_store&#34;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;weekly_sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">last_six_month_window_store</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;sales_last_year_store&#34;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="s2">&#34;weekly_sales&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">last_year_window_store</span><span class="p">))</span>\
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&#34;timestamp&#34;</span><span class="p">)</span>\
        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code></pre></div>
<h4 id="create-sales-fg-feature-group">Create <code>sales_fg</code> feature group</h4>

<p>Differently from the <code>store_fg</code>, for the <code>sales_fg</code> we are going to define a composite primary key. This means that each entry in the <code>sales_fg</code> is going to be uniquely identified by the store, the department and the week. In this case we are going to specify also a partition key. Partitioning is a tool available at your disposal to improve the performances of querying a feature group.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sales_fg_meta</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_feature_group</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;sales_fg&#34;</span><span class="p">,</span>
                                        <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">primary_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;dept&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span>
                                        <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Sales related features&#34;</span><span class="p">,</span>
                                        <span class="n">time_travel_format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                                        
                                        <span class="n">statistics_config</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sales_fg_meta</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sales_fg</span><span class="p">)</span></code></pre></div>
<pre><code>&lt;hsfs.feature_group.FeatureGroup object at 0x7ff4e276ac50&gt;
</code></pre>

<p>When creating a feature group we can also specify a <code>partition key</code>. Partition keys help organize the feature data on the file system and improve perfomances when reading the feature group data. As for the <code>primary key</code>, also <code>partition key</code> can be a composite one.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sales_part_fg_meta</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_feature_group</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;sales_fg&#34;</span><span class="p">,</span>
                                        <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                        <span class="n">partition_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">],</span>
                                        <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Sales related features&#34;</span><span class="p">,</span>
                                        <span class="n">time_travel_format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                                                                                          
                                        <span class="n">statistics_config</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">sales_part_fg_meta</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sales_fg</span><span class="p">)</span></code></pre></div>
<pre><code>&lt;hsfs.feature_group.FeatureGroup object at 0x7ff4e1fddf90&gt;
</code></pre>

<p>You can enable a feature group to be online by setting the <code>online_enabled</code> flag to true.</p>

<p>By default <code>HSFS</code> configures the feature group such that new feature data that gets saved or inserted is written to the offline feature store. If <code>online_enabled=True</code>, additionally, the data is saved to the online storage of the feature store. Note that the insert and save to both storages is not transactional.</p>

<p>If you want to create a purely online feature group. Save the feature group with <code>online_enabled=True</code> but with an empty dataframe and subsequently use the insert with <code>storage=&quot;online&quot;</code> to overwrite the default and write to the online feature store only.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sales_part_fg_meta</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_feature_group</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;sales_fg&#34;</span><span class="p">,</span>
                                        <span class="n">version</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                        <span class="n">primary_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;dept&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span>
                                        <span class="n">online_enabled</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                        <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Sales related features&#34;</span><span class="p">,</span>
                                        <span class="n">time_travel_format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                                             
                                        <span class="n">statistics_config</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">sales_part_fg_meta</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sales_fg</span><span class="p">)</span></code></pre></div>
<pre><code>&lt;hsfs.feature_group.FeatureGroup object at 0x7ff4e1fe1d50&gt;
</code></pre>

<h4 id="feature-engineering-exogenous-features">Feature Engineering Exogenous features</h4>

<p>This feature group will contain exogenous features that can influence sales, but are not under the control of the distribution chain. These are the unemployment, the consumer price index (cpi) and so on.
We are going to write these features as they are in the feature store</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">exogenous_fg</span> <span class="o">=</span> <span class="n">exogenous_csv</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">to_date</span><span class="p">(</span><span class="s2">&#34;date&#34;</span><span class="p">,</span> <span class="s1">&#39;dd/MM/yyy&#39;</span><span class="p">))</span>

<span class="n">exogenous_fg_meta</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_feature_group</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;exogenous_fg&#34;</span><span class="p">,</span>
                                            <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">primary_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span>
                                            <span class="n">description</span><span class="o">=</span><span class="s2">&#34;External features that influence sales, but are not under the control of the distribution chain&#34;</span><span class="p">,</span>
                                            <span class="n">time_travel_format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                                            
                                            <span class="n">statistics_config</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;enabled&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&#34;histograms&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s2">&#34;correlations&#34;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
<span class="n">exogenous_fg_meta</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">exogenous_fg</span><span class="p">)</span></code></pre></div>
<pre><code>&lt;hsfs.feature_group.FeatureGroup object at 0x7ff4e1fad150&gt;
</code></pre>

<h3 id="append-additional-data">Append additional data</h3>

<p>You can add additional data to a feature group by calling the <code>insert</code> method. In the example below we assume that we got also the data for 2013 and we are going to append it to the existing <code>exogenous_fg</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">exogenous_fg_2013</span> <span class="o">=</span> <span class="n">exogenous_fg</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">date_add</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="mi">365</span><span class="p">))</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">exogenous_fg_meta</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_feature_group</span><span class="p">(</span><span class="s1">&#39;exogenous_fg&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">exogenous_fg_meta</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">exogenous_fg_2013</span><span class="p">)</span></code></pre></div>
<p>This will also recompute statistics after inserting new data. The new statistics will be saved along the metadata with a new commit time.</p>

<h3 id="append-an-additional-feature">Append an additional feature</h3>

<p>Appending features to a feature group is a non-breaking schema change compared to removing features, which will require creating a new version of the feature group.</p>

<p>You can append a feature group by specifying a data type and default value for the new feature. The default value is necessary for the data that is already in the feature group.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">hsfs.feature</span> <span class="kn">import</span> <span class="n">Feature</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">exogenous_fg_meta</span><span class="o">.</span><span class="n">append_features</span><span class="p">([</span><span class="n">Feature</span><span class="p">(</span><span class="s2">&#34;appended_feature&#34;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&#34;double&#34;</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="s2">&#34;10.0&#34;</span><span class="p">)])</span></code></pre></div>
<pre><code>&lt;hsfs.feature_group.FeatureGroup object at 0x7ff4e1fe1450&gt;
</code></pre>

<h3 id="add-a-tag-to-a-feature-group">Add a Tag to a feature group</h3>

<p>Using the HSFS api you can add tags to a feature groups. Tags are indexed and you can do free text search from the Hopsworks feature store UI. Tags can be &ldquo;name only&rdquo;, meaning they don&rsquo;t have a value, or you can add a value.</p>

<h4 id="tagging-feature-group">Tagging feature group</h4>

<p>The feature store enables users to attach tags to feature droup in order to make them discoverable across feature
stores.  A tag is a simple {key: value} association, providing additional information about the data, such as for
example geographic origin. This is useful in an organization as it makes easier to discover for data scientists, reduces
duplicated work in terms of for example data preparation. The tagging feature is only available in the enterprise version.</p>

<h4 id="define-tags-that-can-be-attached">Define tags that can be attached</h4>

<p>The first step is to define a set of tags that can be attached. Such as for example “Country” to tag data as being from
a certain geographic location and “Sport” to further associate a type of Sport with the data.</p>

<p><img src="creating_tags.gif" alt="Define tags that can be attached" /></p>

<h4 id="attach-tags-using-the-ui">Attach tags using the UI</h4>

<p>Tags can then be attached using the feature store UI or programmatically using the API.
Attaching tags to feature group.</p>

<p><img src="attach_tags.gif" alt="Attach tags using the UI" /></p>

<h4 id="attach-tags-using-hsfs-api">Attach tags using HSFS API</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sales_fg</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_feature_group</span><span class="p">(</span><span class="s1">&#39;sales_fg&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">sales_fg</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="s1">&#39;Prod&#39;</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sales_fg</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="s1">&#39;Country&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&#34;US&#34;</span><span class="p">)</span></code></pre></div>
<h4 id="retrieval">Retrieval</h4>

<p>From the API you can also list which tags are assigned to a feature group</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sales_fg</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_feature_group</span><span class="p">(</span><span class="s1">&#39;sales_fg&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">sales_fg</span><span class="o">.</span><span class="n">get_tag</span><span class="p">())</span></code></pre></div>
<pre><code>[{'Prod': ''}, {'Country': 'US'}]
</code></pre>

<h3 id="delete-a-feature-group">Delete a feature group</h3>

<p>You can call the <code>delete</code> method on a feature group to delete the entire feature group.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">exogenous_fg_meta</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_feature_group</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;exogenous_fg&#34;</span><span class="p">,</span>
                                        <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                        <span class="n">primary_key</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;store&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">],</span>
                                        <span class="n">description</span><span class="o">=</span><span class="s2">&#34;External features that influence sales, but are not under the control of the distribution chain&#34;</span><span class="p">,</span>
                                        <span class="n">time_travel_format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                                                                                        
                                        <span class="n">statistics_config</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">exogenous_fg_meta</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">exogenous_fg</span><span class="p">)</span></code></pre></div>
<pre><code>&lt;hsfs.feature_group.FeatureGroup object at 0x7ff4e1fe13d0&gt;
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">exogenous_fg_meta</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_feature_group</span><span class="p">(</span><span class="s1">&#39;exogenous_fg&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">exogenous_fg_meta</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"></code></pre></div>
    </div>
    <aside>
      <div class="bug_reporting">
	<h4>Find an error or bug?</h4>
	<p>Everything on this site is available on GitHub. Head to <a href='https://github.com/chrisalbon/notes/issues/new'>and submit a suggested change</a>. Include the tutorial's URL in the issue.</p>
      </div>
    </aside>

  </div>
</article>




            </div>

        </div>
    </div>

    

    <footer class="footer text-center">
        <div class="container">
            <span class="text-muted">This project contains 59 pages and is available on <a href="https://github.com/napsterinblue/notes">GitHub</a>. Copyright &copy; NapsterInBlue, <time datetime="2018">2018</time>.</span>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>

</body>

</html>
