<!DOCTYPE html>
<html lang="en">

<head>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66582-32"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-66582-32');
    </script>

    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Hsfs - Training Dataset Creation" />
<meta property="og:description" content="HSFS training datasets Training datasets is the third building block of the Hopsworks Feature Store. Data scientists can query the feature store (see feature_exploration notebook) and materialize their query in training datasets.
Training datasets can be saved in a ML framework friendly format (eg. TfRecords, CSV, Numpy) and then be fed to a machine learning model for training.
Training datasets can also be stored on external storage systems like Amazon S3 or GCS to be read by external model training platforms." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://examples.hopsworks.ai/featurestore/hsfs/training_datasets/" />



<meta property="article:published_time" content="2021-02-24T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2021-02-24T00:00:00&#43;00:00"/>











<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Hsfs - Training Dataset Creation"/>
<meta name="twitter:description" content="HSFS training datasets Training datasets is the third building block of the Hopsworks Feature Store. Data scientists can query the feature store (see feature_exploration notebook) and materialize their query in training datasets.
Training datasets can be saved in a ML framework friendly format (eg. TfRecords, CSV, Numpy) and then be fed to a machine learning model for training.
Training datasets can also be stored on external storage systems like Amazon S3 or GCS to be read by external model training platforms."/>
<meta name="generator" content="Hugo 0.40.3" />

    
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Hsfs - Training Dataset Creation",
  "url": "https://examples.hopsworks.ai/featurestore/hsfs/training_datasets/",
  "wordCount": "1447",
  "datePublished": "2021-02-24T00:00:00&#43;00:00",
  "dateModified": "2021-02-24T00:00:00&#43;00:00",
  "author": {
  "@type": "Person",
  "name": ""
  }
  }
</script> 

    <title>Hsfs - Training Dataset Creation</title>

    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">

    
    <link href="https://examples.hopsworks.ai/css/custom.css" rel="stylesheet">
    <link href="https://examples.hopsworks.ai/css/syntax.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli:400,500,700" rel="stylesheet">

    <link href="" rel="alternate" type="application/rss+xml" title="Hopsworks Examples" />

    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</head>

<body>

    <nav class="navbar navbar-expand-sm fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="https://examples.hopsworks.ai">Hopsworks Examples</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="nav navbar-nav mr-auto"></ul>
                <ul class="nav navbar-nav">
                    <li><a href="https://hopsworks.ai" title="Hopsworks.ai">hopsworks.ai</a></li>
                    <li><a href="https://docs.hopsworks.ai" title="Docs">docs.hopsworks.ai</a></li>
                </ul>
            </div>
        </div>
    </nav>


    
    <div class="container">
        <div class="row">
            <div class="col-sm-12">

                 


<article>
  <div class="technical_note">
    <header>
      <div class="alert alert-warning flashcard_ad" role="alert">
	Want to learn machine learning? Try my <a href="https://machinelearningflashcards.com" class="alert-link">machine learning flashcards</a>, <a href='https://amzn.to/2HwnWty' class="alert-link">book</a>, or <a href='https://www.youtube.com/channel/UCnd4Fi-ODvuPbxR2fO2j7kA' class="alert-link">study with me.</a>.
      </div>
      <h1 class="technical_note_title">Hsfs - Training Dataset Creation</h1>
      <div class="technical_note_date">
	<time datetime=" 2021-02-24T00:00:00Z "> 24 Feb 2021</time>
      </div>
    </header>
    <div class="content">

      

<h3 id="hsfs-training-datasets">HSFS training datasets</h3>

<p>Training datasets is the third building block of the Hopsworks Feature Store. Data scientists can query the feature store (see <a href="./feature_exploration.ipynb">feature_exploration</a> notebook) and materialize their query in training datasets.</p>

<p>Training datasets can be saved in a ML framework friendly format (eg. TfRecords, CSV, Numpy) and then be fed to a machine learning model for training.</p>

<p>Training datasets can also be stored on external storage systems like Amazon S3 or GCS to be read by external model training platforms.</p>

<p>As with the previous notebooks, the first step is to establish a connection with the Hopsworks feature store and get the feature store handle</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">hsfs</span>
<span class="c1"># Create a connection</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">hsfs</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span>
<span class="c1"># Get the feature store handle for the project&#39;s feature store</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">get_feature_store</span><span class="p">()</span></code></pre></div>
<pre><code>Starting Spark application
</code></pre>

<table>
<tr><th>ID</th><th>YARN Application ID</th><th>Kind</th><th>State</th><th>Spark UI</th><th>Driver log</th></tr><tr><td>6</td><td>application_1604957327609_0010</td><td>pyspark</td><td>idle</td><td><a target="_blank" href="http://hopsworks0.logicalclocks.com:8088/proxy/application_1604957327609_0010/">Link</a></td><td><a target="_blank" href="http://hopsworks0.logicalclocks.com:8042/node/containerlogs/container_e01_1604957327609_0010_01_000001/demo_fs_meb10000__meb10000">Link</a></td></tr></table>

<pre><code>SparkSession available as 'spark'.
Connected. Call `.close()` to terminate connection gracefully.
</code></pre>

<h3 id="create-a-training-dataset-from-a-query">Create a training dataset from a query</h3>

<p>In the previous notebook (<a href="./feature_exploration.ipynb">feature_exploration</a>) we walked through how to explore and query the Hopsworks feature store using HSFS. We can use the queries produced in the previous notebook to create a training dataset.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sales_fg</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_feature_group</span><span class="p">(</span><span class="s1">&#39;sales_fg&#39;</span><span class="p">)</span>
<span class="n">exogenous_fg</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_feature_group</span><span class="p">(</span><span class="s1">&#39;exogenous_fg&#39;</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="n">sales_fg</span><span class="o">.</span><span class="n">select_all</span><span class="p">()</span>\
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exogenous_fg</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;fuel_price&#39;</span><span class="p">,</span> <span class="s1">&#39;unemployment&#39;</span><span class="p">,</span> <span class="s1">&#39;cpi&#39;</span><span class="p">]))</span></code></pre></div>
<pre><code>VersionWarning: No version provided for getting feature group `sales_fg`, defaulting to `1`.
VersionWarning: No version provided for getting feature group `exogenous_fg`, defaulting to `1`.
</code></pre>

<p>As for the feature groups, we first need to generate a metadata object representing the training dataset. After that, we can call the <code>save()</code> method to persist it in the Hopsworks feature store.
Different file formats are available: <code>csv</code>, <code>tfrecord</code>, <code>npy</code>, <code>hdf5</code>, <code>avro</code>, <code>parquet</code>, <code>orc</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;sales_model&#34;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Dataset to train the sales model&#34;</span><span class="p">,</span>
                               <span class="n">data_format</span><span class="o">=</span><span class="s2">&#34;csv&#34;</span><span class="p">,</span>
                               <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">td</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></code></pre></div>
<pre><code>&lt;hsfs.training_dataset.TrainingDataset object at 0x7f94701b38d0&gt;
</code></pre>

<h4 id="pass-write-options">Pass write options</h4>

<p>When you save a training dataset, you have the possibility of specifying additional parameters to the Spark writer. For instance, in the example below, we are adding the headers to the CSV file.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;sales_model&#34;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Dataset to train the sales model&#34;</span><span class="p">,</span>
                               <span class="n">data_format</span><span class="o">=</span><span class="s2">&#34;csv&#34;</span><span class="p">,</span>
                               <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">td</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hearder&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">})</span></code></pre></div>
<pre><code>&lt;hsfs.training_dataset.TrainingDataset object at 0x7f948851b610&gt;
</code></pre>

<h4 id="split-the-training-dataset">Split the training dataset</h4>

<p>If you are training a model, you might want to split the training datasets into different slices (training, test and validation). HSFS allows you to specify the split sizes. You can also provide a seed for the random splitter, if you want to reproduce a training dataset.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;sales_model&#34;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Dataset to train the sales model&#34;</span><span class="p">,</span>
                               <span class="n">data_format</span><span class="o">=</span><span class="s2">&#34;csv&#34;</span><span class="p">,</span>
                               <span class="n">splits</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>
                               <span class="n">version</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">td</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hearder&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">})</span></code></pre></div>
<pre><code>&lt;hsfs.training_dataset.TrainingDataset object at 0x7f9488528510&gt;
</code></pre>

<h4 id="save-the-dataset-on-an-external-storage-system">Save the dataset on an external storage system</h4>

<p>If you are training your model on an external machine learning platform (e.g. SageMaker), you might want to save the training dataset on an external storage system (e.g. S3). You can take advantage of the Hopsworks storage connectors (see <a href="https://hopsworks.readthedocs.io/en/latest/featurestore/guides/featurestore.html#configuring-storage-connectors-for-the-feature-store">documentation</a>).</p>

<p>Assuming you have created an S3 storage connector name <code>td_bucket_connector</code>, you can create an external training dataset as follows:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td_bucket_connector</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_storage_connector</span><span class="p">(</span><span class="s2">&#34;td_bucket_connector&#34;</span><span class="p">,</span> <span class="s2">&#34;S3&#34;</span><span class="p">)</span>

<span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;sales_model&#34;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Dataset to train the sales model&#34;</span><span class="p">,</span>
                               <span class="n">data_format</span><span class="o">=</span><span class="s2">&#34;csv&#34;</span><span class="p">,</span>
                               <span class="n">storage_connector</span><span class="o">=</span><span class="n">td_bucket_connector</span><span class="p">,</span>
                               <span class="n">version</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1">### This code is expected to fail if you connector is not configured properly</span>
<span class="n">td</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></code></pre></div>
<h4 id="replay-the-query-that-generated-the-training-dataset">Replay the query that generated the training dataset</h4>

<p>If you created a training dataset from a query object, then you can ask the feature store to return the set of features (in order) and the set of joins that generated.
This feature is useful if you are serving a model in production and you want to augment the inference vector with features taken from the online feature store</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_training_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;sales_model&#34;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">td</span><span class="o">.</span><span class="n">query</span><span class="p">)</span></code></pre></div>
<pre><code>SELECT `fg0`.`sales_last_quarter_store_dep`, `fg0`.`store`, `fg0`.`sales_last_month_store_dep`, `fg0`.`sales_last_year_store`, `fg0`.`sales_last_quarter_store`, `fg0`.`sales_last_six_month_store_dep`, `fg0`.`sales_last_year_store_dep`, `fg0`.`sales_last_month_store`, `fg0`.`dept`, `fg0`.`sales_last_six_month_store`, `fg0`.`weekly_sales`, `fg0`.`is_holiday`, `fg0`.`date`, `fg1`.`fuel_price`, `fg1`.`unemployment`, `fg1`.`cpi`
FROM `demo_fs_meb10000`.`sales_fg_1` `fg0`
INNER JOIN `demo_fs_meb10000`.`exogenous_fg_1` `fg1` ON `fg0`.`date` = `fg1`.`date` AND `fg0`.`store` = `fg1`.`store`
VersionWarning: No version provided for getting training dataset `sales_model`, defaulting to `1`.
</code></pre>

<h3 id="create-a-training-dataset-from-a-dataframe">Create a training dataset from a DataFrame</h3>

<p>If you need to apply additional transformations before creating a training dataset, you can create one from a Spark DataFrame instead of using a query.
The <code>create_training_dataset</code> part stays the same, the difference is that we are going to pass a DataFrame to the <code>save()</code> method.</p>

<p>As you have applied additional transformations between the query object and the training dataset, we won&rsquo;t be able to re-play the query for this specific training dataset.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="c1"># Apply additional transformations</span>
<span class="n">df</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;is_holiday&#34;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;is_holiday&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
       <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;unemployment&#34;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;unemployment&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;double&#34;</span><span class="p">))</span> 
       <span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&#34;cpi&#34;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&#34;cpi&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&#34;double&#34;</span><span class="p">))</span>
       <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&#34;date&#34;</span><span class="p">))</span></code></pre></div>
<h4 id="save-as-csv-format">save as <code>csv</code> format</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;sales_model&#34;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Dataset to train the sales model&#34;</span><span class="p">,</span>
                               <span class="n">data_format</span><span class="o">=</span><span class="s2">&#34;csv&#34;</span><span class="p">,</span>
                               <span class="n">splits</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>                                
                               <span class="n">version</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">td</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code></pre></div>
<pre><code>&lt;hsfs.training_dataset.TrainingDataset object at 0x7f94884e0150&gt;
</code></pre>

<h4 id="save-as-tfrecord-format">save as <code>tfrecord</code> format</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">create_training_dataset</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;sales_model&#34;</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Dataset to train the sales model&#34;</span><span class="p">,</span>
                               <span class="n">data_format</span><span class="o">=</span><span class="s2">&#34;tfrecord&#34;</span><span class="p">,</span>
                               <span class="n">splits</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">},</span>                                
                               <span class="n">version</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="n">td</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code></pre></div>
<pre><code>&lt;hsfs.training_dataset.TrainingDataset object at 0x7f948849f210&gt;
</code></pre>

<h3 id="add-a-tag-to-a-training-dataset">Add a tag to a training dataset</h3>

<p>As for feature groups, you can add tags to a training dataset. Tags are indexed and you can search for them in the Hopsworks feature store UI. Tags are an useful tool to catalog the feature store. The <code>value</code> field can be omitted.</p>

<h4 id="tagging-training-datasets">Tagging Training Datasets</h4>

<p>The feature store enables users to attach tags to training dataset in order to make them discoverable across feature
stores.  A tag is a simple {key: value} association, providing additional information about the data, such as for
example geographic origin. This is useful in an organization as it makes easier to discover for data scientists, reduces
duplicated work in terms of for example data preparation. The tagging feature is only available in the enterprise version.</p>

<h4 id="define-tags-that-can-be-attached">Define tags that can be attached</h4>

<p>The first step is to define a set of tags that can be attached. Such as for example “Country” to tag data as being from
a certain geographic location and “Sport” to further associate a type of Sport with the data.</p>

<p><img src="images/creating_tags.gif" alt="Define tags that can be attached" /></p>

<h4 id="attach-tags-using-the-ui">Attach tags using the UI</h4>

<p>Tags can then be attached using the feature store UI or programmatically using the API.
Attaching tags to feature group.</p>

<p><img src="images/attach_tags.gif" alt="Attach tags using the UI" /></p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_training_dataset</span><span class="p">(</span><span class="s2">&#34;sales_model&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">td</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="s2">&#34;model&#34;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s2">&#34;sales&#34;</span><span class="p">)</span></code></pre></div>
<p>From the HSFS API you can also list all the tags associated with a specific training dataset</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_training_dataset</span><span class="p">(</span><span class="s2">&#34;sales_model&#34;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">td</span><span class="o">.</span><span class="n">get_tag</span><span class="p">()</span></code></pre></div>
<pre><code>[{'model': 'sales'}]
</code></pre>

<h3 id="read-a-training-dataset">Read a training dataset</h3>

<p>As for feature groups, you can call the methods <code>show()</code> method to get a preview of the training dataset and <code>read()</code> to get a Spark DataFrame of it.</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_training_dataset</span><span class="p">(</span><span class="s2">&#34;sales_model&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">td</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></code></pre></div>
<pre><code>+----------------------------+-----+--------------------------+---------------------+------------------------+------------------------------+-------------------------+----------------------+----+--------------------------+------------+----------+-------------------+----------+------------+-----------+
|sales_last_quarter_store_dep|store|sales_last_month_store_dep|sales_last_year_store|sales_last_quarter_store|sales_last_six_month_store_dep|sales_last_year_store_dep|sales_last_month_store|dept|sales_last_six_month_store|weekly_sales|is_holiday|               date|fuel_price|unemployment|        cpi|
+----------------------------+-----+--------------------------+---------------------+------------------------+------------------------------+-------------------------+----------------------+----+--------------------------+------------+----------+-------------------+----------+------------+-----------+
|                         0.0|   20|                       0.0|                  0.0|                     0.0|                           0.0|                      0.0|                   0.0|  55|                       0.0|    32362.95|     false|2010-02-05 00:00:00|     2.784|       8.187|204.2471935|
|                         0.0|   20|                       0.0|                  0.0|                     0.0|                           0.0|                      0.0|                   0.0|  94|                       0.0|    63787.83|     false|2010-02-05 00:00:00|     2.784|       8.187|204.2471935|
|                         0.0|   20|                       0.0|                  0.0|                     0.0|                           0.0|                      0.0|                   0.0|  22|                       0.0|    17597.83|     false|2010-02-05 00:00:00|     2.784|       8.187|204.2471935|
|                         0.0|   20|                       0.0|                  0.0|                     0.0|                           0.0|                      0.0|                   0.0|  30|                       0.0|     9488.37|     false|2010-02-05 00:00:00|     2.784|       8.187|204.2471935|
|                         0.0|   20|                       0.0|                  0.0|                     0.0|                           0.0|                      0.0|                   0.0|   2|                       0.0|    85812.69|     false|2010-02-05 00:00:00|     2.784|       8.187|204.2471935|
+----------------------------+-----+--------------------------+---------------------+------------------------+------------------------------+-------------------------+----------------------+----+--------------------------+------------+----------+-------------------+----------+------------+-----------+
only showing top 5 rows
</code></pre>

<p>If you have splitted your training dataset, you can also read a single split</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_training_dataset</span><span class="p">(</span><span class="s2">&#34;sales_model&#34;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">td</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;train&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></code></pre></div>
<pre><code>295125
</code></pre>

<h3 id="input-the-training-dataset-to-a-model-training-loop">Input the training dataset to a model training loop</h3>

<p>If you are training a model, HSFS provides <code>tf_data</code> method that returns <code>TFDataEngine</code> object with utility methods to read training dataset as <code>tf.data.Dataset</code> object to read the training dataset and feed it to a model training loop efficiently.
* Currently <code>TFDataEngine</code> provides 2 utility methods <code>tf_record_dataset</code> and <code>tf_csv_dataset</code> for reading <code>.tfrecord</code> and <code>.csv</code> files, respectivelly.
* Both methods support only following feature types <code>string</code>, <code>short</code>, <code>int</code>, <code>long</code>, <code>float</code> and <code>double</code>.
* In both methods you can set <code>process</code> argument to <code>True</code> and they will return <code>PrefetchDataset</code> ready to input to model training loop.
* If you would like to apply your own logic to feature transformation using <code>tf.data.Dataset</code> then set <code>process</code> argument to <code>False</code>.</p>

<h4 id="proccess-using-tf-record-dataset">proccess using <code>tf_record_dataset</code>:</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">train_input</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">tf_data</span><span class="p">(</span><span class="n">target_name</span><span class="o">=</span><span class="s1">&#39;weekly_sales&#39;</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">train_input_processed</span> <span class="o">=</span> <span class="n">train_input</span><span class="o">.</span><span class="n">tf_record_dataset</span><span class="p">(</span><span class="n">process</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">train_input_processed</span></code></pre></div>
<pre><code>&lt;PrefetchDataset shapes: ((32, 14), (32,)), types: (tf.float32, tf.float32)&gt;
</code></pre>

<h4 id="apply-custom-logic-to-tf-record-dataset">Apply custom logic to <code>tf_record_dataset</code>:</h4>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">td</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">get_training_dataset</span><span class="p">(</span><span class="s2">&#34;sales_model&#34;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

<span class="n">train_input</span> <span class="o">=</span> <span class="n">td</span><span class="o">.</span><span class="n">tf_data</span><span class="p">(</span><span class="n">target_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">train_input_not_processed</span> <span class="o">=</span> <span class="n">train_input</span><span class="o">.</span><span class="n">tf_record_dataset</span><span class="p">()</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">train_input_not_processed</span></code></pre></div>
<pre><code>&lt;ParallelMapDataset shapes: {cpi: (), dept: (), fuel_price: (), is_holiday: (), sales_last_month_store: (), sales_last_month_store_dep: (), sales_last_quarter_store: (), sales_last_quarter_store_dep: (), sales_last_six_month_store: (), sales_last_six_month_store_dep: (), sales_last_year_store: (), sales_last_year_store_dep: (), store: (), unemployment: (), weekly_sales: ()}, types: {cpi: tf.float32, dept: tf.int64, fuel_price: tf.float32, is_holiday: tf.int64, sales_last_month_store: tf.float32, sales_last_month_store_dep: tf.float32, sales_last_quarter_store: tf.float32, sales_last_quarter_store_dep: tf.float32, sales_last_six_month_store: tf.float32, sales_last_six_month_store_dep: tf.float32, sales_last_year_store: tf.float32, sales_last_year_store_dep: tf.float32, store: tf.int64, unemployment: tf.float32, weekly_sales: tf.float32}&gt;
</code></pre>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="kn">as</span> <span class="nn">tf</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">num_epochs</span> <span class="o">=</span> <span class="mi">1</span> 

<span class="k">def</span> <span class="nf">custom_impl</span><span class="p">(</span><span class="n">example</span><span class="p">):</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">td_feature</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">td_feature</span> <span class="ow">in</span> <span class="n">td</span><span class="o">.</span><span class="n">schema</span><span class="p">]</span> 
    <span class="n">label_name</span> <span class="o">=</span> <span class="n">feature_names</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;weekly_sales&#39;</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">example</span><span class="p">[</span><span class="n">feature_name</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">example</span><span class="p">[</span><span class="n">label_name</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>

<span class="n">train_input_custum_processed</span> <span class="o">=</span> <span class="n">train_input_not_processed</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">custom_impl</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>\
    <span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">num_epochs</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">num_epochs</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">cache</span><span class="p">()</span>\
    <span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>\
    <span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span><span class="p">)</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">train_input_custum_processed</span></code></pre></div>
<pre><code>&lt;PrefetchDataset shapes: ((32, 14), (32,)), types: (tf.float32, tf.float32)&gt;
</code></pre>

    </div>
    <aside>
      <div class="bug_reporting">
	<h4>Find an error or bug?</h4>
	<p>Everything on this site is available on GitHub. Head to <a href='https://github.com/chrisalbon/notes/issues/new'>and submit a suggested change</a>. Include the tutorial's URL in the issue.</p>
      </div>
    </aside>

  </div>
</article>




            </div>

        </div>
    </div>

    

    <footer class="footer text-center">
        <div class="container">
            <span class="text-muted">This project contains 59 pages and is available on <a href="https://github.com/napsterinblue/notes">GitHub</a>. Copyright &copy; NapsterInBlue, <time datetime="2018">2018</time>.</span>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>

</body>

</html>
