<!DOCTYPE html>
<html lang="en">

<head>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-66582-32"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-66582-32');
    </script>

    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="Kafka Python Feature Store Example" />
<meta property="og:description" content="Producing and Consuming Messages to/from Kafka, using Python Clients Tested with python 3.6 and python 2.7
Before running this notebook, you should have created a Kafka topic with a name that you can configure in the TOPIC_NAME variable below in the code.
The screenshots below illustrates the steps necessary to create a Kafka topic on Hops
In this notebook we use two python dependencies:
 hops-util-py confluent-kafka-python  To install the confluent-kafka-python libary, use the Hopsworks UI:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://examples.hopsworks.ai/kafka/kafkapython/" />



<meta property="article:published_time" content="2021-02-24T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2021-02-24T00:00:00&#43;00:00"/>











<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kafka Python Feature Store Example"/>
<meta name="twitter:description" content="Producing and Consuming Messages to/from Kafka, using Python Clients Tested with python 3.6 and python 2.7
Before running this notebook, you should have created a Kafka topic with a name that you can configure in the TOPIC_NAME variable below in the code.
The screenshots below illustrates the steps necessary to create a Kafka topic on Hops
In this notebook we use two python dependencies:
 hops-util-py confluent-kafka-python  To install the confluent-kafka-python libary, use the Hopsworks UI:"/>
<meta name="generator" content="Hugo 0.40.3" />

    
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "Kafka Python Feature Store Example",
  "url": "https://examples.hopsworks.ai/kafka/kafkapython/",
  "wordCount": "785",
  "datePublished": "2021-02-24T00:00:00&#43;00:00",
  "dateModified": "2021-02-24T00:00:00&#43;00:00",
  "author": {
  "@type": "Person",
  "name": ""
  }
  }
</script> 

    <title>Kafka Python Feature Store Example</title>

    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">

    
    <link href="https://examples.hopsworks.ai/css/custom.css" rel="stylesheet">
    <link href="https://examples.hopsworks.ai/css/syntax.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli:400,500,700" rel="stylesheet">

    <link href="" rel="alternate" type="application/rss+xml" title="Hopsworks Examples" />

    <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[','\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre','code'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>

</head>

<body>

    <nav class="navbar navbar-expand-sm fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="https://examples.hopsworks.ai">Hopsworks Examples</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="nav navbar-nav mr-auto"></ul>
                <ul class="nav navbar-nav">
                    <li><a href="https://hopsworks.ai" title="Hopsworks.ai">hopsworks.ai</a></li>
                    <li><a href="https://docs.hopsworks.ai" title="Docs">docs.hopsworks.ai</a></li>
                </ul>
            </div>
        </div>
    </nav>


    
    <div class="container">
        <div class="row">
            <div class="col-sm-12">

                 


<article>
  <div class="technical_note">
    <header>
      <div class="alert alert-warning flashcard_ad" role="alert">
	Want to learn machine learning? Try my <a href="https://machinelearningflashcards.com" class="alert-link">machine learning flashcards</a>, <a href='https://amzn.to/2HwnWty' class="alert-link">book</a>, or <a href='https://www.youtube.com/channel/UCnd4Fi-ODvuPbxR2fO2j7kA' class="alert-link">study with me.</a>.
      </div>
      <h1 class="technical_note_title">Kafka Python Feature Store Example</h1>
      <div class="technical_note_date">
	<time datetime=" 2021-02-24T00:00:00Z "> 24 Feb 2021</time>
      </div>
    </header>
    <div class="content">

      

<h1 id="producing-and-consuming-messages-to-from-kafka-using-python-clients">Producing and Consuming Messages to/from Kafka, using Python Clients</h1>

<p style="color:red">Tested with python 3.6 and python 2.7</p>

<p>Before running this notebook, you should have created a Kafka topic with a name that you can configure in the <code>TOPIC_NAME</code> variable below in the code.</p>

<p>The screenshots below illustrates the steps necessary to create a Kafka topic on Hops</p>

<p><img src="kafka.png" alt="kafka.png" />
<img src="kafka2.png" alt="kafka2.png" />
<img src="kafka3.png" alt="kafka3.png" />
<img src="kafka4.png" alt="kafka4.png" />
<img src="kafka5.png" alt="kafka5.png" />
<img src="kafka6.png" alt="kafka6.png" />
<img src="kafka7.png" alt="kafka7.png" />
<img src="kafka8.png" alt="kafka8.png" /></p>

<p>In this notebook we use two python dependencies:</p>

<ul>
<li><a href="https://github.com/logicalclocks/hops-util-py">hops-util-py</a></li>
<li><a href="https://github.com/confluentinc/confluent-kafka-python">confluent-kafka-python</a></li>
</ul>

<p>To install the <code>confluent-kafka-python</code> libary, use the Hopsworks UI:</p>

<p><img src="kafka9.png" alt="kafka9.png" />
<img src="kafka10.png" alt="kafka10.png" /></p>

<p>The hops-util library is already installed by default when projects are created on Hops. However, if you need to re-install it for some reason you can use the Hopsworks UI to first uninstall it and the install it from pip using the same method as described above.</p>

<h2 id="imports">Imports</h2>
<div class="highlight"><pre class="chroma"><code class="language-pyspark" data-lang="pyspark">from hops import kafka
from hops import tls
from confluent_kafka import Producer, Consumer</code></pre></div>
<pre><code>Starting Spark application
</code></pre>

<table>
<tr><th>ID</th><th>YARN Application ID</th><th>Kind</th><th>State</th><th>Spark UI</th><th>Driver log</th><th>Current session?</th></tr><tr><td>31</td><td>application_1538483294796_0034</td><td>pyspark</td><td>idle</td><td><a target="_blank" href="http://hopsworks0:8088/proxy/application_1538483294796_0034/">Link</a></td><td><a target="_blank" href="http://hopsworks0:8042/node/containerlogs/container_e01_1538483294796_0034_01_000001/KafkaPython__meb10000">Link</a></td><td>âœ”</td></tr></table>

<pre><code>SparkSession available as 'spark'.
</code></pre>

<h2 id="constants">Constants</h2>

<p>Define the name of the topic you have created here</p>
<div class="highlight"><pre class="chroma"><code class="language-pyspark" data-lang="pyspark">TOPIC_NAME = &#34;test&#34;</code></pre></div>
<p>We can get the schema  defined for the topic by using the utility-library to make a REST-call to Hopsworks:</p>
<div class="highlight"><pre class="chroma"><code class="language-pyspark" data-lang="pyspark">kafka.get_schema(TOPIC_NAME)</code></pre></div>
<pre><code>{'contents': '[]', 'version': 0}
</code></pre>

<h2 id="define-kafka-config">Define Kafka Config</h2>

<p>The hops-util-py library provides utility methods for setting up secure communication using Kafka producers and consumers running inside a Hopsworks cluster. You can use this utility methods in combination with any python kafka client. In this noteobook we will be using confluent-kafka-python.</p>
<div class="highlight"><pre class="chroma"><code class="language-pyspark" data-lang="pyspark">config = {
    &#34;bootstrap.servers&#34;: kafka.get_broker_endpoints(),
    &#34;security.protocol&#34;: kafka.get_security_protocol(),
    &#34;ssl.ca.location&#34;: tls.get_ca_chain_location(),
    &#34;ssl.certificate.location&#34;: tls.get_client_certificate_location(),
    &#34;ssl.key.location&#34;: tls.get_client_key_location(),
    &#34;group.id&#34;: &#34;something&#34;
}
# equivalently you can use:
# config = kafka.get_kafka_default_config()</code></pre></div>
<h2 id="create-kafka-producer-and-consumer">Create Kafka Producer and Consumer</h2>
<div class="highlight"><pre class="chroma"><code class="language-pyspark" data-lang="pyspark">producer = Producer(config)
consumer = Consumer(config)</code></pre></div>
<h2 id="subscribe-the-consumer-to-your-topic">Subscribe the Consumer to your Topic</h2>

<p>The confluent_kafka api provides a callback-hook for getting notified when a consumer has been assigned to a different Kafka partition</p>
<div class="highlight"><pre class="chroma"><code class="language-pyspark" data-lang="pyspark">def print_assignment(consumer, partitions):
    &#34;&#34;&#34; 
    Callback called when a Kafka consumer is assigned to a partition
    &#34;&#34;&#34;
    print(&#39;Assignment:&#39;, partitions)</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-pyspark" data-lang="pyspark"># the consumer can be subscribed to multiple topics
topics = [TOPIC_NAME]
consumer.subscribe(topics, on_assign=print_assignment)</code></pre></div>
<h2 id="produce-messages-to-your-topic-using-the-producer">Produce Messages to your Topic Using the Producer</h2>

<p>The confluent_kafka api provides a callback-hook so that we can get notified once messages have been successfully acknowledged by the Kafka brokers (the produce method is asynchronous so when it returns we cannot be guaranteed that messages actually was received by the brokers)</p>
<div class="highlight"><pre class="chroma"><code class="language-pyspark" data-lang="pyspark">def delivery_callback(err, msg):
    &#34;&#34;&#34;
    Optional per-message delivery callback (triggered by poll() or flush())
    when a message has been successfully delivered or permanently
    failed delivery (after retries).
    &#34;&#34;&#34;
    if err:
        print(&#34;Message failed delivery: {}&#34;.format(err))
    else:
        print(&#39;Message: {} delivered to topic: {}, partition: {}, offset: {}, timestamp: {}&#39;.format(msg.value(), msg.topic(), msg.partition(), msg.offset(), msg.timestamp()))</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-pyspark" data-lang="pyspark">for i in range(0, 10):
    producer.produce(TOPIC_NAME, &#34;message {}&#34;.format(i), &#34;key&#34;, callback=delivery_callback)

# Trigger the sending of all messages to the brokers, 10sec timeout
producer.flush(10) </code></pre></div>
<pre><code>Message: b'message 0' delivered to topic: test, partition: 1, offset: 70, timestamp: (1, 1538566389535)
Message: b'message 1' delivered to topic: test, partition: 1, offset: 71, timestamp: (1, 1538566389535)
Message: b'message 2' delivered to topic: test, partition: 1, offset: 72, timestamp: (1, 1538566389535)
Message: b'message 3' delivered to topic: test, partition: 1, offset: 73, timestamp: (1, 1538566389535)
Message: b'message 4' delivered to topic: test, partition: 1, offset: 74, timestamp: (1, 1538566389535)
Message: b'message 5' delivered to topic: test, partition: 1, offset: 75, timestamp: (1, 1538566389535)
Message: b'message 6' delivered to topic: test, partition: 1, offset: 76, timestamp: (1, 1538566389535)
Message: b'message 7' delivered to topic: test, partition: 1, offset: 77, timestamp: (1, 1538566389535)
Message: b'message 8' delivered to topic: test, partition: 1, offset: 78, timestamp: (1, 1538566389535)
Message: b'message 9' delivered to topic: test, partition: 1, offset: 79, timestamp: (1, 1538566389535)
0
</code></pre>

<h2 id="poll-messages-from-your-topic-using-the-consumer">Poll Messages from your Topic Using the Consumer</h2>
<div class="highlight"><pre class="chroma"><code class="language-pyspark" data-lang="pyspark">for i in range(0, 10):
    msg = consumer.poll(timeout=5.0)
    if msg is not None:
        print(&#39;Consumed Message: {} from topic: {}, partition: {}, offset: {}, timestamp: {}&#39;.format(msg.value(), msg.topic(), msg.partition(), msg.offset(), msg.timestamp()))
    else:
        print(&#34;Topic empty, timeout when trying to consume message, try to produce messages to the topic and then re-consume&#34;)</code></pre></div>
<pre><code>Consumed Message: b'message 0' from topic: test, partition: 1, offset: 70, timestamp: (1, 1538566389535)
Consumed Message: b'message 1' from topic: test, partition: 1, offset: 71, timestamp: (1, 1538566389535)
Consumed Message: b'message 2' from topic: test, partition: 1, offset: 72, timestamp: (1, 1538566389535)
Consumed Message: b'message 3' from topic: test, partition: 1, offset: 73, timestamp: (1, 1538566389535)
Consumed Message: b'message 4' from topic: test, partition: 1, offset: 74, timestamp: (1, 1538566389535)
Consumed Message: b'message 5' from topic: test, partition: 1, offset: 75, timestamp: (1, 1538566389535)
Consumed Message: b'message 6' from topic: test, partition: 1, offset: 76, timestamp: (1, 1538566389535)
Consumed Message: b'message 7' from topic: test, partition: 1, offset: 77, timestamp: (1, 1538566389535)
Consumed Message: b'message 8' from topic: test, partition: 1, offset: 78, timestamp: (1, 1538566389535)
Consumed Message: b'message 9' from topic: test, partition: 1, offset: 79, timestamp: (1, 1538566389535)
</code></pre>

    </div>
    <aside>
      <div class="bug_reporting">
	<h4>Find an error or bug?</h4>
	<p>Everything on this site is available on GitHub. Head to <a href='https://github.com/chrisalbon/notes/issues/new'>and submit a suggested change</a>. Include the tutorial's URL in the issue.</p>
      </div>
    </aside>

  </div>
</article>




            </div>

        </div>
    </div>

    

    <footer class="footer text-center">
        <div class="container">
            <span class="text-muted">This project contains 59 pages and is available on <a href="https://github.com/napsterinblue/notes">GitHub</a>. Copyright &copy; NapsterInBlue, <time datetime="2018">2018</time>.</span>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>

</body>

</html>
